/*! ias 2013-03-23 */
var g2g_info={version:"v0.1"},g2g=function(t){"use strict";return t.GraphComponent=function(t,e,o,n,r){this.x=e,this.y=o,this.color=n,this.parent=t,this.g=t.append("g").attr("transform","translate("+e+","+o+")"),r&&this.g.attr("class",r)},t.GraphComponent.prototype.getXY=function(){return{x:this.x,y:this.y}},t.GraphComponent.prototype.setVisible=function(t){return this.g.style("display",t?"inline":"none"),this},t.GraphComponent.prototype.getNode=function(){return this.g},t.GraphComponent.prototype.draw=function(){return this},t.GraphComponent.prototype.select=function(){return this},t.GraphComponent.prototype.moveOnTop=function(){return this.parent.appendChild(this),this},t.Link=function(e,o,n,r){t.GraphComponent.call(this,e,0,0,n,r),this.elements=[],this.closed=!1;var i=d3.svg.area().x(function(t){return t.x}).y(function(t){return t.y}).interpolate(o),a=[];this.path=function(){return i(a)},this.addElement=function(t){var e=t.getXY();return this.elements.push(t),a.push(e),a.sort(function(t,e){return t.y-e.y}),this},this.close=function(){return this.closed?void 0:(a.push(this.elements[0].getXY()),this.closed=!0,this)}},t.Link.prototype=Object.create(t.GraphComponent.prototype),t.Link.prototype.select=function(t){return this.setVisible(t),this.elements.forEach(function(e){e.select(t)}),this},t.Link.prototype.draw=function(){return this.g.append("path").attr("d",this.path()).style("stroke",this.color),this},t.Options=function(t){if(this.listeners={},t){var e;for(e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}},t.Options.prototype.addListener=function(t,e){var o=Array.isArray(t)?t:[t],n=this;o.forEach(function(t){n.listeners.hasOwnProperty(t)===!1&&(n.listeners[t]=[]),e&&"function"==typeof e&&n.listeners[t].push(e)})},t.Options.prototype.getValue=function(t){return this.hasOwnProperty(t)?this[t]:void 0},t.Options.prototype.change=function(t,e){var o,n,r,i,a=t;if(t.indexOf(".")>0?(o=t.split("."),a=o[0],n=this[a][o[1]]):n=this[a],this.hasOwnProperty(a)&&n!==e&&(o?this[a][o[1]]=e:this[a]=e,this.listeners.hasOwnProperty(a)))for(i=this.listeners[a],r=0;i.length>r;r+=1)i[r].call(this,a)},t}(g2g_info),ias_info={mode:"offline",modules:[],config:{}},ias=function(t){"use strict";function e(e,o,n,r,i,a,s){var c;if(e)throw c="Error while loading data: "+e.message,t.showError(c),c;try{t.modules.forEach(function(t){t.init({world:o,centroids:n,networks:r,cohorts:i,hivrates:a,arvrates:s})}),t.modules.forEach(function(t){t.hasOwnProperty("run")&&t.run()}),t.showError()}catch(l){throw t.showError("Error while initializing IAS modules: "+l),l}}function o(e,o,n){var r;if(e)throw r="Error while loading data: "+e.message,t.showError(r),r;try{t.modules.forEach(function(t){t.update({networks:o,cohorts:n})}),t.showError()}catch(i){throw t.showError("Error while updating IAS modules: "+i),i}}return t.log=function(){console&&console.log&&console.log.apply(console,arguments)},t.showError=function(){d3.select("#error").text(arguments?arguments[0]:"")},t.launchApp=function(){return d3.json("./ias-config.json",function(e,o){if(e)throw"Error while loading configuration file: "+e.message;t.config=o;var n=window.top.location.search.replace("?","").split("=");t.mode=2===n.length&&"mode"===n[0]?n[1].replace("/",""):"offline",d3.select("#mode").text(t.mode+" mode"),t.loadData(t.mode)}),t},t.loadData=function(o){return queue().defer(d3.json,t.config.data.mapGeoJson).defer(d3.json,t.config.data.mapCentroids).defer(d3.json,t.config.data[o+"Networks"]).defer(d3.json,t.config.data[o+"Cohorts"]).defer(d3.csv,t.config.data.hivPrevalenceRate).defer(d3.csv,t.config.data.arvCoverageRate).await(e),t},t.reloadData=function(e){return queue().defer(d3.json,t.config.data[e+"Networks"]).defer(d3.json,t.config.data[e+"Cohorts"]).await(o),t},t}(ias_info);ias.util=function(){"use strict";var t,e={},o=d3.scale.linear(),n={},r={};return e.getNetworkColor=function(t){return n.hasOwnProperty(t)?n[t]:(ias.log("network color for"+t+" not found"),"white")},e.getCountryColor=function(t){var o=ias.model.getCountryById(t),n=o[ias.filter.getBackgroundInfoOption()];return void 0!==n&&"na"!==n?e.getBackgroundColor(n):ias.config.map.background.naColor},e.getBackgroundColor=function(t){return o(t)},e.getSelectedDomainRates=function(){return r[ias.filter.getBackgroundInfoOption()]},e.getCountryColorByFeature=function(t){var o=ias.model.getCountry(t.properties.name),n=o[ias.filter.getBackgroundInfoOption()];return void 0!==n&&"na"!==n?e.getBackgroundColor(n):ias.config.map.background.naColor},e.getCountryId=function(t){var e=t.id;return"-99"===e?"9"+t.properties.name.substring(0,2):t.id},e.getCohortHtml=function(t){var e="<span class='tooltip title'>Cohort</span><h1 class='tooltip'>"+t.name+":</h1>";return e+="<b>Number of subjects:</b>&nbsp;"+t.size+"<br>",e+="<b>Network:&nbsp;</b>"+t.getNetwork()+"<br>",e+="<b>Status:</b>&nbsp;"+t.status+"<br>",e+="<b>Countries:</b>&nbsp;",e+=t.getCountries().map(function(t){return t.name}).join(", ")+"<br>",e+="<b>Objectives:&nbsp;</b>",e+="<span class='tooltip objectives'>"+t.objectives+"</span>",e+="<br><br><a class='tooltip' target='_blank' href='"+ias.config.map.cohort.fullProfile.replace("$code$",t.code)+"'>View Full Profile</a>"},e.getCountryHtml=function(t){var e="<span class='tooltip title'>Country   "+t.id+"</span><h1 class='tooltip'>"+t.name+"</h1><table>",o="white";return e+="<tr><td class='firstcol'>HIV Prevalence Rate</td><td class='secondcol'>",e+=(t.hivPrevalenceRate||"na")+" %</td></tr>",e+="<tr><td>ARV Coverage Rate</td><td class='secondcol'>",e+=(t.arvCoverageRate||"na")+" %</td></tr>",t.cohorts&&t.cohorts.length>0&&(e+="<tr><td colspane='2'><br><b>COHORTS:</b></td></tr>",t.cohorts.forEach(function(t){o=ias.util.getNetworkColor(t.networks[0]),e+="<tr><td class='firstcol'><span style='background:",e+=o+";'>&nbsp;&nbsp;&nbsp;</span>&nbsp;",e+=t.name+"</td><td class='secondcol'>",e+=t.size+"</td></tr>"}),e+="<tr><td class='firstcol' style='text-align:right;'><b>Total</b></td><td class='secondcol'><b>",e+=t.size+"</b></td></tr>"),e+="</table>"},e.init=function(o){var i,a;t=ias.config.network.colorSchemes,o.networks.children.forEach(function(e,o){i=d3.scale.ordinal().range(colorbrewer[t[o]][6]),e.children.forEach(function(t){n[t.code]=i(t.code)})}),a=o.hivrates.filter(function(t){return!isNaN(t.rate)}).map(function(t){return parseFloat(t.rate)}),r.hivPrevalenceRate=[d3.min(a),d3.max(a)],a=o.arvrates.filter(function(t){return!isNaN(t.rate)}).map(function(t){return parseFloat(t.rate)}),r.arvCoverageRate=[d3.min(a),d3.max(a)],e.initBackgroundColors()},e.initBackgroundColors=function(){o.domain(e.getSelectedDomainRates()),o.range([ias.config.map.background.startColor,ias.config.map.background.endColor])},e.update=function(){},ias.modules.push(e),e}(),ias.filter=function(){"use strict";function t(t,e){var o=d3.select("#"+t).selectAll("input").data(e).enter().append("div");o.append("input").attr("checked",!0).attr("type","checkbox").attr("id",function(e){return t+e}).attr("value",function(t){return t}).attr("selected","selected"),o.append("label").attr("for",function(e){return t+e}).attr("class",t).text(function(t){return t})}var e,o,n={},r={},i=[],a={};for(e=1980;2013>=e;e+=1)i.push(e);return n.BACKGROUND_INFO="backgroundInfo",n.YEAR="year",n.NETWORKS="networks",n.ENROLLMENT_STATUS="enrollmentStatus",n.AGE_GROUP="ageGroup",a[n.BACKGROUND_INFO]="hivPrevalenceRate",a[n.YEAR]="1980",a[n.NETWORKS]={},a[n.ENROLLMENT_STATUS]="All",a[n.AGE_GROUP]="All",o=new g2g.Options(a),n.getValue=function(t){return o.getValue(t)},n.getBackgroundInfoOption=function(){return n.getValue(n.BACKGROUND_INFO)},n.addListener=function(t,e){o.addListener(t,e)},d3.select("#backgroundInfo").on("change",function(){var t=this.options[this.selectedIndex].value;o.change(n.BACKGROUND_INFO,t)}),d3.select("#year").on("change",function(){var t=parseInt(this.options[this.selectedIndex].value,10);o.change(n.YEAR,t)}).selectAll("option").data(i).enter().append("option").attr("value",function(t){return t}).text(function(t){return t}),n.init=function(e){function i(t,e){var o=t.code;return"EuroCoord"===o||"IeDEA"===o||"Other"===o?"network":"network "+e}function a(t){return"EuroCoord"===t||"IeDEA"===t||"Other"===t?"rgb(255,255,255)":ias.util.getNetworkColor(t)}function s(t,e){var r=e.code;"EuroCoord"===r||"IeDEA"===r||"Other"===r?d3.selectAll("input.network."+r).each(function(e){d3.select(this).property("checked",t.checked),o.change(n.NETWORKS+"."+e.code,t.checked)}):o.change(n.NETWORKS+"."+r,t.checked)}function c(t){var e=t.replace(/^rgb?\(|\s+|\)$/g,"").split(","),o=.3*e[0]+.59*e[1]+.11*e[2];return o}var l,u;r=ias.config.filter,d3.select("#status").on("change",function(){var t=this.options[this.selectedIndex].value;o.change(n.ENROLLMENT_STATUS,t)}).selectAll("option").data(r.enrollmentStatus).enter().append("option").attr("value",function(t){return t}).text(function(t){return t}),t("ageGroup",r.ageGroup),t("subjectStatus",r.subjectStatus),e.networks.children.forEach(function(t){l=t.children,l.forEach(function(t){o.networks[t.code]=!0}),l.unshift({code:t.code,name:t.name}),u=d3.select("#"+t.code).selectAll("div").data(l).enter().append("div").attr("class",function(e){return t.code!==e.code?"subnetwork":"network"}),u.append("input").attr("checked",!0).attr("class",function(e){return i(e,t.code)}).attr("type","checkbox").attr("id",function(t){return"n"+t.code}).on("click",function(t){return s(this,t)}),u.append("label").attr("class",function(e){return t.code===e.code?"network title":"network"}).attr("for",function(t){return"n"+t.code}).style("background",function(t){return c(a(t.code)),a(t.code)}).style("color",function(t){var e=a(t.code),o=c(e);return 130>o?"lightgray":"#666"}).text(function(t){return t.name}),"Other"!==t&&u.append("br")})},n.update=function(){},ias.modules.push(n),n}(),ias.model=function(){"use strict";var t={worldJson:{},networks:{},allcountries:[],allcountriesByName:{},allcountriesById:{},countriesWithCohorts:[],cohorts:[]};return t.getCountry=function(e){var o=t.allcountriesByName[e];return o},t.getCountryById=function(e){var o=t.allcountriesById[e];return o},t.init=function(e){t.worldJson=e.world,t.networks=e.networks.children,t.worldJson.features.forEach(function(e){var o=new ias.model.Country(e);t.allcountries.push(o),t.allcountriesByName[o.name]=o,t.allcountriesById[o.id]=o}),e.hivrates.forEach(function(e){var o=t.allcountriesByName[e.country];void 0!==o?o.hivPrevalenceRate=parseFloat(e.rate):ias.log("HIV Rates: no country found for "+e.country)}),e.arvrates.forEach(function(e){var o=t.allcountriesByName[e.country],n=parseFloat(e.rate);void 0!==o?o.arvCoverageRate=isNaN(n)?"na":n:ias.log("ARV Rates: no country found for "+e.country)}),e.cohorts.forEach(function(e){var o=new ias.model.Cohort(e);t.cohorts.push(o)}),t.allcountries.forEach(function(e){e.numberOfCohorts()>0&&t.countriesWithCohorts.push(e)})},t.update=function(){},ias.modules.push(t),t}(),ias.model=function(t){"use strict";return t.Country=function(t){this.feature=t,this.networks={},this.cohorts=[],this.hivPrevalenceRate="na",this.arvCoverageRate="na",this.size=0,this.id=t.id,"-99"===this.id&&(this.id="9"+t.properties.name.substring(0,2)),this.name=this.feature.properties.name},t.Country.prototype.addNetwork=function(t){this.networks.hasOwnProperty(t)===!1&&(this.networks[t]=t)},t.Country.prototype.getNetworks=function(){return Object.keys(this.networks)},t.Country.prototype.numberOfCohorts=function(){return this.cohorts?this.cohorts.length:0},t.Country.prototype.addCohort=function(t){return this.cohorts.push(t),this.size+=t.size,this},t.Country.prototype.getCohortIds=function(){var t=[];return this.cohorts&&this.cohorts.length>0&&this.cohorts.forEach(function(e){t.push(e.code)}),t},t}(ias.model||{}),ias.model=function(t){"use strict";return t.CountryData={countryId:"",size:0,country:null},t}(ias.model||{}),ias.model=function(t){"use strict";return t.Cohort=function(e){this.status=e.status,this.code=e.code,this.name=e.name,this.objectives=e.objectives,this.year=e.year,this.size=e.size,this.networks=e.networks,this.countryData={};var o=this;e.countries.forEach(function(n){var r=t.allcountriesById[n.trim()];r?(o.addCountryData(r.id,10,r),r.addCohort(o),r.addNetwork(e.networks[0])):ias.log("Cohort country not found for "+n)})},t.Cohort.prototype.getCountryData=function(t){return this.countryData[t]},t.Cohort.prototype.getCountries=function(){var t=[];for(var e in this.countryData)this.countryData.hasOwnProperty(e)&&t.push(this.countryData[e].country);return t},t.Cohort.prototype.getCountryIds=function(){return Object.keys(this.countryData)},t.Cohort.prototype.addCountryData=function(t,e,o){var n=Object.create(ias.model.CountryData);n.countryId=t,n.size=e,n.country=o,this.countryData[t]=n,this.numberOfCountries+=1},t.Cohort.prototype.getNetwork=function(){return this.networks[0]},t}(ias.model||{}),ias.graph=function(){"use strict";var t={components:[],selectedCohort:void 0,tooltip:{country:{},cohort:{}}};return t.projection=d3.geo.equirectangular().scale(140),t.path=d3.geo.path().projection(t.projection),t.init=function(e){var o,n,r={};o=d3.select("#map").append("svg").attr("width",ias.config.map.width).attr("height",ias.config.map.height),n=d3.select("#legend").append("svg").attr("width",ias.config.legend.width).attr("height",ias.config.legend.height),t.map=ias.graph.map(o),t.components.push(t.map),t.legend=ias.graph.legend(n),t.components.push(t.legend),e.centroids.forEach(function(t){r[t.id]=t.ll}),t.tooltip.country=ias.graph.tooltip("tooltipCountry",ias.config.map.tooltip.country,"","country"),t.tooltip.cohort=ias.graph.tooltip("tooltipCohort",ias.config.map.tooltip.cohort,"","cohort"),ias.model.countriesWithCohorts.forEach(function(e){var o=[],n=r[e.name];o=n===void 0?t.path.centroid(e.feature):t.projection(n),e.centroidx=o[0],e.centroidy=o[1]})},t.update=function(){},t.run=function(){t.components.forEach(function(t){t.draw()})},t.selectCohort=function(e){t.selectedCohort!==e&&(t.selectedCohort!==void 0&&t.map.deselect(t.selectedCohort),t.selectedCohort=e,e!==void 0&&t.map.select(t.selectedCohort))},t.ZoomFactor=function(t){this.scales=t?t:[1,3,6],this.current=0,this.scale=function(){return this.scales[this.current]},this.factor=function(){return this.current+"x"},this.in=function(){return this.current===this.scales.length-1?!1:(this.current+=1,!0)},this.out=function(){return 0===this.current?!1:(this.current-=1,!0)}},ias.modules.push(t),t}(),ias.graph=function(t){"use strict";return t.tooltip=function(t,e,o,n){var r={},i=d3.select("body").append("div").attr("class","tooltip "+(n||"")).attr("id",t).style("left",e[0]+"px").style("top",e[1]+"px").style("opacity",0).html(o);return r.show=function(){return i.transition().duration(100).style("opacity",1),r},r.hide=function(){return i.transition().duration(200).style("opacity",0),r},r.html=function(t){return i.html(t),r},r.style=function(t,e){return i.style(t,e),r},r.move=function(t){return i.style("left",t[0]+"px").style("top",t[1]+"px"),r},r},t}(ias.graph||{}),ias.graph=function(t){"use strict";function e(t,e,o){var n=o?.15:.9,r=o?"black":"#333",i=o?"bold":"normal";t.parent.selectAll("circle.cohort:not(."+e.cssIdClass+")").style("opacity",n),t.parent.selectAll("g.country.pin:not(."+e.cssIdClass+")").style("opacity",n),t.parent.selectAll("circle.country.pin."+e.cssIdClass).style("stroke",r),t.parent.selectAll("text.country.pin."+e.cssIdClass).style("fill",r).style("font-weight",i),t.parent.selectAll("text.country.pin.subjects."+e.cssIdClass).style("display",o?"none":"inline")}function o(t,o){o.cohorts||(e(t,o,!0),ias.graph.selectedCohort&&ias.graph.tooltip.cohort.hide())}function n(t,o){o.cohorts||(e(t,o,!1),ias.graph.selectedCohort&&ias.graph.tooltip.cohort.show())}function r(t,e){d3.event.stopPropagation(),e.cohorts||ias.graph.selectCohort(e)}return t.CountryPin=function(t,e){this.country=e,this.maxRadius=20,this.minRadius=5,this.scale=d3.scale.sqrt().domain([0,3e5]).range([this.minRadius,this.maxRadius]),this.link=null,this.radius=this.scale(this.country.size),this.pack=d3.layout.pack().size([this.radius,this.radius]).value(function(t){return t.size}).children(function(t){return t.cohorts}),this.nodes=this.pack.nodes(this.country);var o="";this.country.cohorts.forEach(function(t){t.cssIdClass="c"+t.code,o+=" "+t.cssIdClass}),this.classes="pin country"+o,g2g.GraphComponent.call(this,t,this.country.centroidx-this.radius/2,this.country.centroidy-this.radius/2,ias.util.getCountryColor(this.country.id),this.classes)},t.CountryPin.prototype=Object.create(g2g.GraphComponent.prototype),t.CountryPin.prototype.filter=function(){var t=ias.filter.getValue(ias.filter.NETWORKS),e=ias.filter.getValue(ias.filter.ENROLLMENT_STATUS),o=this;return this.country.cohorts.forEach(function(n){var r=t[n.getNetwork()];r&="All"===e||n.status===e,o.g.select("#"+o.country.id+"-"+n.code).style("display",r?"inline":"none")}),this},t.CountryPin.prototype.draw=function(){var t=this.g.selectAll("circle").data(this.nodes).enter(),e=this;return t.append("svg:circle").attr("class",function(t){return t.cohorts?e.classes:"cohort "+t.getNetwork()+" "+t.cssIdClass}).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.r}).attr("id",function(t){return e.country.id+"-"+t.code}).style("fill",function(t){return t.cohorts?"gray":ias.util.getNetworkColor(t.getNetwork())}).on("mouseover",function(t){o(e,t)}).on("mouseout",function(t){n(e,t)}).on("click",function(t){r(e,t)}),this.g.append("svg:text").attr("x",this.country.x).attr("y",this.country.y-1*this.radius/2).attr("dy","-.3em").attr("text-anchor","middle").attr("class",this.classes).text(this.country.name),this},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.map=function(t){function e(t,e){B[0]+=t[0],B[1]+=t[1];var o=I.scale(),n=-B[0]+ias.config.map.width/2/o,r=-B[1]+ias.config.map.height/2/o;E.transition().duration(e).attr("transform","scale("+o+") translate("+n+","+r+")")}function o(t){d3.event.stopPropagation(),t&&(B=ias.graph.path.centroid(t),I.scale()>1&&e([0,0],1e3),n(t))}function n(t){var e=ias.util.getCountryId(t),o=ias.model.allcountriesById[e];w&&i(!1),w=o,ias.graph.tooltip.country.html(ias.util.getCountryHtml(o)).show(),i(!0)}function r(){i(!1),ias.graph.tooltip.country.hide(),w=null,ias.graph.selectCohort()}function i(t){var e=t?"darkred":"#fff",o=t?.5:.1;try{d3.select("#"+w.id).style("stroke",e).style("stroke-width",o+"px")}catch(n){}}function a(){var t=I.out();t&&(1===I.scale()&&(B=ias.graph.projection([0,0]),B[1]+=x),e([0,0],1e3),ias.graph.legend.zoomed(I))}function s(){var t=I.in();t&&(e([0,0],1e3),ias.graph.legend.zoomed(I))}function c(){e([0,-10],500)}function l(){e([0,10],500)}function u(){e([10,0],500)}function d(){e([-10,0],500)}function h(){var t;R&&(t=[-(d3.event.x-k[0]),-(d3.event.y-k[1])],k=[d3.event.x,d3.event.y],e(t,0),d3.event.preventDefault(),d3.event.stopPropagation())}function p(){I.scale()>1&&(d3.event.preventDefault(),d3.event.stopPropagation(),t.style("cursor","move"),R=!0,k=[d3.event.x,d3.event.y])}function f(){R=!1,t.style("cursor","pointer")}function g(){t.on("mousemove",h).on("mousedown",p).on("mouseup",f).on("click",r),O.selectAll("path").data(ias.model.worldJson.features).enter().append("path").attr("class","country").attr("d",ias.graph.path).attr("pointer-events","fill").style("fill",function(t){return ias.util.getCountryColorByFeature(t)}).attr("id",function(t){return ias.util.getCountryId(t)}).style("opacity",ias.config.map.background.opacity).on("click",o),O.select("#ATA").remove(),ias.model.countriesWithCohorts.forEach(function(t){var e=new ias.graph.CountryPin(N,t).draw();A.push(e)})}function y(){}function m(t){return t===ias.filter.BACKGROUND_INFO?(ias.util.initBackgroundColors(),O.selectAll("path").style("fill",function(t){return ias.util.getCountryColorByFeature(t)}),void 0):(A.forEach(function(t){t.filter()}),void 0)}function v(t){ias.log("select "+(t?t.code:"")),"Cohort"===t.constructor.name&&(ias.graph.tooltip.cohort.html(ias.util.getCohortHtml(t)).show(),N.selectAll("circle.cohort."+t.cssIdClass).classed("selected",!0))}function C(t){ias.log("deselect "+(t?t.code:"")),"Cohort"===t.constructor.name&&(ias.graph.tooltip.cohort.hide(),N.selectAll("circle.cohort."+t.cssIdClass).classed("selected",!1))}var w,k,b=-100,x=-20,E=t.append("g").attr("id","mapcontainer").attr("transform","translate("+b+","+x+")"),O=E.append("g").attr("id","map").attr("class","map"),N=E.append("g").attr("id","pins_country").attr("class","pin country"),A=[],I=new ias.graph.ZoomFactor,R=!1,B=ias.graph.projection([0,0]);return ias.filter.addListener([ias.filter.NETWORKS,ias.filter.YEAR,ias.filter.ENROLLMENT_STATUS,ias.filter.BACKGROUND_INFO],m),{draw:g,update:y,filterUpdate:m,zoomout:a,zoomin:s,moveup:c,movedown:l,moveright:u,moveleft:d,select:v,deselect:C}},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.legend=function(t){function e(t,e,o,n){h.append("image").attr("xlink:href","images/"+t+".png").attr("width",20).attr("height",20).attr("x",e).attr("y",o).attr("id",t).style("cursor","pointer").style("opacity",function(){return n?n:.2}).style("pointer-events",function(){return n?"all":"none"}).on("click",ias.graph.map[t])}function o(){var t=ias.util.getSelectedDomainRates();m.tickValues(t),p.selectAll("stop").data(f).enter().append("svg:stop").attr("offset",function(t){return t+"%"}).attr("stop-color",function(e){return t[0]>e||e>t[1]?"white":ias.util.getBackgroundColor(e)}).attr("stop-opacity",1),u.append("g").attr("class","x axis").attr("transform","translate(10, 25)").call(y),u.append("g").attr("class","x axis selected").attr("transform","translate(10, 45)").call(m),u.append("svg:rect").attr("class","legend").attr("y",25).attr("x",10).attr("width",120).attr("height",20).style("fill","url(#gradient)").style("stroke","#000").style("stroke-width",".3px"),u.append("rect").attr("class","legend").attr("x",145).attr("y",25).attr("width",20).attr("height",20).style("stroke","#000").style("stroke-width",".3px").style("fill",ias.config.map.background.naColor).attr("dx",-3).attr("dy",".35em"),u.append("text").attr("x",150).attr("y",15).attr("class","legend background").text("n/a"),u.append("text").attr("x",10).attr("y",0).attr("id","backgroundInfoTitle").attr("class","title legend").text(ias.config.legend.hivPrevalenceRate)}function n(){var t=ias.config.legend.cohorts,e=d3.scale.sqrt().domain([0,3e5]).range([2,15]);d.selectAll("circle").data(t).enter().append("circle").attr("cx",20).attr("cy",function(t){return 50-e(t)}).style("fill","none","opacity",1).style("stroke",ias.config.map.cohort.linkcolor).style("stroke-width","1px").attr("r",function(t){return e(t)}),d.selectAll("text").data(t).enter().append("text").attr("y",function(t){return 50-2*e(t)+4}).attr("x",40).attr("class","legend").text(function(t,e){return 4===e?">"+t:t}),u.append("text").attr("x",200).attr("y",0).attr("class","title legend").text("Cohort Size")}function r(){e("zoomin",50,20,1),e("zoomout",25,20),e("moveup",-20,10),e("movedown",-20,30),e("moveleft",-35,20),e("moveright",-5,20),h.append("text").attr("x",80).attr("y",32).attr("id","zoomFactor").text("0x"),o(),n(),t.append("g").append("text").attr("x",ias.config.legend.width).attr("y",ias.config.legend.height).style("text-anchor","end").style("font-size","0.7em").style("fill","gray").text("version: "+ias.config.version+" - "+ias.config.timestamp)}function i(){}function a(t){var e=t.scale();h.selectAll("#moveup, #movedown, #moveright, #moveleft, #zoomout").transition().duration(1e3).style("opacity",1===e?"0.2":"1").style("pointer-events",1===e?"none":"all"),h.select("#zoomin").transition().duration(1e3).style("opacity",3>=e?"1":"0.2").style("pointer-events",3>=e?"all":"none"),h.select("#zoomFactor").text(t.factor())}function s(){var t=ias.filter.getBackgroundInfoOption();u.select("#backgroundInfoTitle").text(ias.config.legend[t]);var e=ias.util.getSelectedDomainRates();m.tickValues(e),u.select(".x.axis.selected").call(m),p.selectAll("stop").attr("offset",function(t){return t+"%"}).attr("stop-color",function(t){return e[0]>t||t>e[1]?"white":ias.util.getBackgroundColor(t)}).attr("stop-opacity",1)}for(var c=0,l=20,u=t.append("g").attr("id","blegend").attr("transform","translate("+c+","+l+")"),d=t.append("g").attr("id","clegend").attr("transform","translate("+(c+200)+","+l+")"),h=t.append("g").attr("id","buttons").style("pointer-events","none").attr("transform","translate("+(c+680)+","+5+")"),p=t.append("svg:defs").append("svg:linearGradient").attr("id","gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),f=[],g=d3.scale.linear().domain([0,100]).range([0,120]),y=d3.svg.axis().scale(g).orient("top").ticks(5),m=d3.svg.axis().scale(g).orient("bottom"),v=0;100>v;v++)f[v]=v;return ias.filter.addListener(ias.filter.BACKGROUND_INFO,s),{draw:r,update:i,filterUpdate:s,zoomed:a}},t}(ias.graph||{}),ias.launchApp();