var g2g_info={version:"v0.1"},g2g=function(my){"use strict";return my.GraphComponent=function(parentSvg,x,y,color,classes){this.x=x,this.y=y,this.color=color,this.parent=parentSvg,this.g=parentSvg.append("g").attr("transform","translate("+x+","+y+")"),classes&&this.g.attr("class",classes)},my.GraphComponent.prototype.getXY=function(){return{x:this.x,y:this.y}},my.GraphComponent.prototype.setVisible=function(visible){return this.g.style("display",visible?"inline":"none"),this},my.GraphComponent.prototype.getNode=function(){return this.g},my.GraphComponent.prototype.draw=function(){return this},my.GraphComponent.prototype.select=function(){return this},my.GraphComponent.prototype.id=function(id){return this.g.attr("id",id),this},my.GraphComponent.prototype.on=function(event,callback){return this.g.on(event,callback),this},my.GraphComponent.prototype.moveOnTop=function(){return this.parent.appendChild(this),this},my.Link=function(parentSvg,interpolation,color,classes){my.GraphComponent.call(this,parentSvg,0,0,color,classes),this.elements=[],this.closed=!1;var d3line=d3.svg.area().x(function(d){return d.x}).y(function(d){return d.y}).interpolate(interpolation),pathCoords=[];this.path=function(){return d3line(pathCoords)},this.addElement=function(elt){var xy=elt.getXY();return this.elements.push(elt),pathCoords.push(xy),pathCoords.sort(function(p1,p2){return p1.y-p2.y}),this},this.close=function(){return this.closed?void 0:(pathCoords.push(this.elements[0].getXY()),this.closed=!0,this)}},my.Link.prototype=Object.create(my.GraphComponent.prototype),my.Link.prototype.select=function(selected){return this.setVisible(selected),this.elements.forEach(function(e){e.select(selected)}),this},my.Link.prototype.draw=function(){return this.g.append("path").attr("d",this.path()).style("stroke",this.color),this},my.Options=function(opts){if(this.listeners={},opts){var name;for(name in opts)opts.hasOwnProperty(name)&&(this[name]=opts[name])}},my.Options.prototype.addListener=function(options,callback){var opts=Array.isArray(options)?options:[options],that=this;opts.forEach(function(o){that.listeners.hasOwnProperty(o)===!1&&(that.listeners[o]=[]),callback&&"function"==typeof callback&&that.listeners[o].push(callback)})},my.Options.prototype.getValue=function(option){return this.hasOwnProperty(option)?this[option]:void 0},my.Options.prototype.change=function(option,newValue){var path,value,i,listeners,opt=option;if(option.indexOf(".")>0?(path=option.split("."),opt=path[0],value=this[opt][path[1]]):value=this[opt],this.hasOwnProperty(opt)&&value!==newValue&&(path?this[opt][path[1]]=newValue:this[opt]=newValue,this.listeners.hasOwnProperty(opt)))for(listeners=this.listeners[opt],i=0;listeners.length>i;i+=1)listeners[i].call(this,opt)},my.Pin=function(svg,x,y,text,color1,color2,size,classes,amount){my.GraphComponent.call(this,svg,x,y,color1,classes),this.text=text,this.color1=color1,this.color2=color2,this.size=size,this.x=x,this.y=y,this.amount=amount},my.Pin.prototype=Object.create(my.GraphComponent.prototype),my.Pin.prototype.draw=function(){var pi=Math.PI,radius=this.size/2,height=4*radius,arc=d3.svg.arc().innerRadius(0).outerRadius(radius).startAngle(pi/2).endAngle(-pi/2),arccoh=d3.svg.arc().innerRadius(0).outerRadius(radius-4).startAngle(0).endAngle(2*pi*this.amount);return this.g.append("path").attr("class","pin").attr("d",arc).attr("transform","translate(0, +1)").style("fill",this.color1).style("stroke-width",0),this.g.append("path").attr("class","pin").attr("d",function(){return"M "+-radius+" 0 l "+2*radius+" 0 l "+-radius+" "+height+" z"}).style("fill",this.color1).style("stroke-width",0),this.g.append("circle").attr("cx",0).attr("cy",0).attr("class","pin").style("fill",this.color2).attr("r",radius-3).style("stroke-width",0).style("opacity",1),this.g.append("path").attr("d",arccoh).style("fill","steelblue").style("stroke-width",0),this.g.append("text").attr("dx",0).attr("dy","0.35em").attr("class","pin").style("text-anchor","middle").text(this.text),this.g.attr("transform","translate("+this.x+","+(this.y+-height)+")"),this},my}(g2g_info),ias_info={mode:"offline",modules:[],config:{}},ias=function(my){"use strict";function showMap(error,world,centroids,networks,cohorts,unaidsinfo){var mess;if(error)throw mess="Error while loading data: "+error.message,my.showError(mess),mess;try{my.modules.forEach(function(m){m.init({world:world,centroids:centroids,networks:networks,cohorts:cohorts,unaidsinfo:unaidsinfo})}),my.modules.forEach(function(m){m.hasOwnProperty("run")&&m.run()}),my.showError()}catch(e){throw my.showError("Error while initializing IAS modules: "+e),e}}function updateMap(error,networks,cohorts){var mess;if(error)throw mess="Error while loading data: "+error.message,my.showError(mess),mess;try{my.modules.forEach(function(m){m.update({networks:networks,cohorts:cohorts})}),my.showError()}catch(e){throw my.showError("Error while updating IAS modules: "+e),e}}return my.log=function(){console&&console.log&&console.log.apply(console,arguments)},my.showError=function(){d3.select("#error").text(arguments?arguments[0]:"")},my.launchApp=function(){return d3.json("./ias-config.json",function(error,configuration){if(error)throw"Error while loading configuration file: "+error.message;my.config=configuration;var modeParameter=window.top.location.search.replace("?","").split("=");my.mode=2===modeParameter.length&&"mode"===modeParameter[0]?modeParameter[1].replace("/",""):"offline",d3.select("#mode").text(my.mode+" mode"),my.loadData(my.mode)}),my},my.loadData=function(mode){return queue().defer(d3.json,my.config.data.mapGeoJson).defer(d3.json,my.config.data.mapCentroids).defer(d3.json,my.config.data[mode+"Networks"]).defer(d3.json,my.config.data[mode+"Cohorts"]).defer(d3.json,my.config.data[mode+"UnaidsInfo"]).await(showMap),my},my.reloadData=function(mode){return queue().defer(d3.json,my.config.data[mode+"Networks"]).defer(d3.json,my.config.data[mode+"Cohorts"]).await(updateMap),my},my}(ias_info);ias.util=function(){"use strict";var that={},backgroundScale=d3.scale.quantile(),networkColors={};return that.getNetworkColor=function(code){return networkColors.hasOwnProperty(code)?networkColors[code]:"white"},that.getCountryColor=function(id){var country=ias.model.getCountryById(id),rate=country.getUnaidsinfo(ias.filter.getBackgroundInfoOption());return that.getBackgroundColor(rate)},that.getBackgroundColor=function(rate){return isNaN(rate)?ias.config.map.background.naColor:backgroundScale(rate)},that.getCountryColorByFeature=function(feature){var rate,country=ias.model.getCountryById(feature.id);return country&&(rate=country.getUnaidsinfo(ias.filter.getBackgroundInfoOption())),that.getBackgroundColor(rate)},that.getCountryId=function(feature){var i=feature.id;return"-99"===i?"9"+feature.properties.name.substring(0,2):feature.id},that.getCohortHtml=function(cohort){var h="<h1 class='tooltip'>"+cohort.name+"</h1>";return h+="<a class='tooltip' target='_blank' href='"+ias.config.map.cohort.fullProfile.replace("$code$",cohort.code)+"'>View Full Profile</a><br><br>",h+="<b>Number of subjects:</b>&nbsp;"+cohort.size+"<br>",h+="<b>Network:&nbsp;</b>"+cohort.getNetwork()+"<br>",h+="<b>Status:</b>&nbsp;"+cohort.status+"<br>",h+="<b>Year of initiation:</b>&nbsp;"+cohort.year+"<br>",h+="<b>Countries:</b>&nbsp;",h+=cohort.getCountries().map(function(d){return d.name}).join(", ")+"<br>",h+="<b>Subjects:&nbsp;</b><br>",h+="<br><div id='tooltipsvg'></div>"},that.getCountryHtml=function(country){var h="<h1 class='tooltip'>"+country.name+"</h1><table>",color="white";return ias.config.map.background.types.forEach(function(t){h+="<tr><td class='firstcol'>",h+=ias.config.map.background[t].label,h+="</td><td class='secondcol'>",h+=country.getUnaidsinfo(t)+" "+ias.config.map.background[t].unit,h+="</td></tr>"}),h+="<tr><td colspane='2'><br><b>COHORTS:</b></td></tr>",country.cohorts&&country.cohorts.length>0?(country.cohorts.forEach(function(c){color=ias.util.getNetworkColor(c.networks[0]),h+="<tr><td class='firstcol'><span style='background:",h+=color+";'>&nbsp;&nbsp;&nbsp;</span>&nbsp;",h+=c.name+"</td><td class='secondcol'>",h+=c.size+"</td></tr>"}),h+="<tr><td class='firstcol' style='text-align:right;'><b>Total</b></td><td class='secondcol'><b>",h+=country.size+"</b></td></tr>"):h+="<tr><td class='firstcol'>No cohorts.</td></tr>",h+="</table>"},that.init=function(params){var codes,nScale;codes=params.networks.map(function(n){return n.code}),nScale=d3.scale.category20c().domain(codes),codes.forEach(function(c){networkColors[c]=nScale(c)}),that.initBackgroundColors()},that.initBackgroundColors=function(){var b=ias.config.map.background[ias.filter.getBackgroundInfoOption()];backgroundScale.domain(b.bands),backgroundScale.range(b.colors)},that.update=function(){},ias.modules.push(that),that}(),ias.filter=function(){"use strict";function createCheckBoxes(node,data,type){var nodeEnter=d3.select("#"+node).selectAll("input").data(data).enter().append("div");nodeEnter.append("input").attr("checked",!0).attr("type","checkbox").attr("id",function(v){return node+"."+v}).attr("value",function(d){return d}).attr("selected","selected").on("click",function(d){options.change(type+"."+d,this.checked)}),nodeEnter.append("label").attr("for",function(v){return node+v}).attr("class",node).text(function(d){return d}),data.forEach(function(d){options[type][d]=!0})}var y,options,that={},config={},years=[],baseOptions={};for(y=1980;2013>=y;y+=1)years.push(y);return that.BACKGROUND_INFO="backgroundInfo",that.YEAR="year",that.NETWORKS="networks",that.ENROLLMENT_STATUS="enrollmentStatus",that.AGE_GROUP="ageGroup",that.SUBJECT_STATUS="subjectStatus",baseOptions[that.BACKGROUND_INFO]="HIV",baseOptions[that.YEAR]=1980,baseOptions[that.NETWORKS]={},baseOptions[that.ENROLLMENT_STATUS]="All",baseOptions[that.AGE_GROUP]={},baseOptions[that.SUBJECT_STATUS]={},options=new g2g.Options(baseOptions),that.getValue=function(option){return options.getValue(option)},that.getBackgroundInfoOption=function(){return that.getValue(that.BACKGROUND_INFO)},that.addListener=function(names,callback){options.addListener(names,callback)},d3.select("#year").on("change",function(){var newYear=parseInt(this.options[this.selectedIndex].value,10);options.change(that.YEAR,newYear)}).selectAll("option").data(years).enter().append("option").attr("value",function(d){return d}).text(function(d){return d}),that.init=function(params){function click(input,network){var code=network.code;options.change(that.NETWORKS+"."+code,input.checked)}var nodeEnter;config=ias.config.filter,d3.select("#backgroundInfo").on("change",function(){var v=this.options[this.selectedIndex].value;options.change(that.BACKGROUND_INFO,v)}).selectAll("option").data(ias.config.map.background.types).enter().append("option").attr("value",function(d){return d}).text(function(d){return ias.config.map.background[d].label}),d3.select("#mapInfo").text("version: "+ias.config.version+" - "+ias.config.timestamp+"  ("+ias.mode+")"),d3.select("#status").on("change",function(){var newEnrollmentStatus=this.options[this.selectedIndex].value;options.change(that.ENROLLMENT_STATUS,newEnrollmentStatus)}).selectAll("option").data(config.enrollmentStatus).enter().append("option").attr("value",function(d){return d}).text(function(d){return d}),createCheckBoxes("ageGroup",config.ageGroup,that.AGE_GROUP),createCheckBoxes("subjectStatus",config.subjectStatus,that.SUBJECT_STATUS),params.networks.sort(function(a,b){return d3.ascending(a.code,b.code)});var i=Math.round(params.networks.length/2),n=[params.networks.slice(0,i),params.networks.slice(i,params.networks.length)];n.forEach(function(data,index){data.forEach(function(n){options.networks[n.code]=!0}),nodeEnter=d3.select("#net"+(index+1)).selectAll("div").data(data).enter().append("div").attr("class","network"),nodeEnter.append("input").attr("checked",!0).attr("class","network").attr("type","checkbox").attr("id",function(v){return"n"+v.code}).on("click",function(v){return click(this,v)}),nodeEnter.append("span").text("__").style("color",function(v){return ias.util.getNetworkColor(v.code)}).style("background",function(v){return ias.util.getNetworkColor(v.code)}),nodeEnter.append("label").attr("class","network").attr("for",function(v){return"n"+v.code}).text(function(d){return" "+d.name})})},that.update=function(){},ias.modules.push(that),that}(),ias.model=function(){"use strict";var that={worldJson:{},networks:{},allcountries:[],allcountriesByName:{},allcountriesById:{},countriesWithCohorts:[],cohorts:[]};return that.getCountry=function(name){var c=that.allcountriesByName[name];return c},that.getCountryById=function(id){var c=that.allcountriesById[id];return c},that.init=function(params){that.worldJson=params.world,that.networks=params.networks.children,that.worldJson.features.forEach(function(f){var c=new ias.model.Country(f);that.allcountries.push(c),that.allcountriesByName[c.name]=c,that.allcountriesById[c.id]=c}),params.unaidsinfo.forEach(function(r){var c=that.allcountriesById[r.iso];void 0!==c?c.setUnaidsinfos(r):ias.log("Unaids Infos: no country found for "+r.iso)}),params.cohorts.forEach(function(d){var coh=new ias.model.Cohort(d);that.cohorts.push(coh)}),that.allcountries.forEach(function(c){c.numberOfCohorts()>0&&that.countriesWithCohorts.push(c)})},that.update=function(){},ias.modules.push(that),that}(),ias.model=function(model){"use strict";function getSubjects(json){if(json){var result={groups:d3.map(),subgroups:d3.map(),data:{}};return json.forEach(function(s){result.subgroups.set(s.subgroup,s.subgroup),result.groups.set(s.group,s.group),s.group in result.data?(result.data[s.group].subjects.push({name:s.subgroup,total:s.male+s.female,male:s.male,female:s.female}),result.data[s.group].total+=s.male+s.female):result.data[s.group]={group:s.group,total:s.male+s.female,subjects:[{name:s.subgroup,total:s.male+s.female,male:s.male,female:s.female}]}}),result}return void 0}return model.Cohort=function(cohortJson){this.status=cohortJson.status,this.code=cohortJson.code,this.name=cohortJson.name,this.objectives=cohortJson.objectives,this.year=parseFloat(cohortJson.year),this.size=cohortJson.size,this.networks=cohortJson.networks,this.countryData={};var that=this;cohortJson.countries.forEach(function(d){var country=model.allcountriesById[d.trim()];country?(that.addCountryData(country.id,10,country),country.addCohort(that),country.addNetwork(cohortJson.networks[0])):ias.log("Cohort country not found for "+d)}),this.subjects=getSubjects(cohortJson.subjects)},model.Cohort.prototype.getCountryData=function(countryId){return this.countryData[countryId]},model.Cohort.prototype.getCountries=function(){var vals=[];for(var key in this.countryData)this.countryData.hasOwnProperty(key)&&vals.push(this.countryData[key].country);return vals},model.Cohort.prototype.getCountryIds=function(){return Object.keys(this.countryData)},model.Cohort.prototype.addCountryData=function(id,size,country){var d=Object.create(ias.model.CountryData);d.countryId=id,d.size=size,d.country=country,this.countryData[id]=d,this.numberOfCountries+=1},model.Cohort.prototype.getNetwork=function(){return this.networks[0]},model}(ias.model||{}),ias.model=function(model){"use strict";return model.Country=function(feature){this.feature=feature,this.networks={},this.cohorts=[],this.size=0,this.id=feature.id,"-99"===this.id&&(this.id="9"+feature.properties.name.substring(0,2)),this.name=this.feature.properties.name,this.unaidsinfos={}},model.Country.prototype.addNetwork=function(network){this.networks.hasOwnProperty(network)===!1&&(this.networks[network]=network)},model.Country.prototype.getUnaidsinfo=function(type){return this.unaidsinfos.hasOwnProperty(type)?this.unaidsinfos[type]:0/0},model.Country.prototype.setUnaidsinfos=function(infos){var types=ias.config.map.background.types,that=this;types.forEach(function(t){that.unaidsinfos[t]=parseFloat(infos[t])*ias.config.map.background[t].factor})},model.Country.prototype.getNetworks=function(){return Object.keys(this.networks)},model.Country.prototype.numberOfCohorts=function(){return this.cohorts?this.cohorts.length:0},model.Country.prototype.addCohort=function(cohort){return this.cohorts.push(cohort),this.size+=cohort.size,this},model.Country.prototype.getCohortIds=function(){var result=[];return this.cohorts&&this.cohorts.length>0&&this.cohorts.forEach(function(c){result.push(c.code)}),result},model}(ias.model||{}),ias.model=function(model){"use strict";return model.CountryData={countryId:"",size:0,country:null},model}(ias.model||{}),ias.graph=function(){"use strict";var that={components:[],tooltip:{country:{},cohort:{}}};return that.projection=d3.geo.miller().precision(.1).scale(153),that.path=d3.geo.path().projection(that.projection),that.init=function(params){var mapsvg,legendsvg,titlesvg,zoomsvg,overloadCentroids={};mapsvg=d3.select("#map").append("svg").attr("class","map").attr("width",ias.config.map.width).attr("height",ias.config.map.height),legendsvg=d3.select("#legend").append("svg").attr("class","legend").attr("width",ias.config.legend.width).attr("height",ias.config.legend.height),titlesvg=d3.select("#title").append("svg").attr("class","title").attr("width",380).attr("height",50),zoomsvg=d3.select("#zoom").append("svg").attr("class","zoom").attr("width",180).attr("height",60),that.zoom=ias.graph.zoom(zoomsvg),that.components.push(that.zoom),that.map=ias.graph.map(mapsvg),that.components.push(that.map),that.legend=ias.graph.legend(legendsvg),that.components.push(that.legend),that.components.push(ias.graph.title(titlesvg)),params.centroids.forEach(function(c){overloadCentroids[c.id]=c.ll}),that.tooltip.country=ias.graph.tooltip("tooltipCountry",ias.config.map.tooltip.country,"","country"),that.tooltip.cohort=ias.graph.tooltip("tooltipCohort",ias.config.map.tooltip.cohort,"","cohort"),ias.model.countriesWithCohorts.forEach(function(country){var coords=[],overcoords=overloadCentroids[country.name];coords=overcoords===void 0?that.path.centroid(country.feature):that.projection(overcoords),country.centroidx=coords[0],country.centroidy=coords[1]})},that.update=function(){},that.run=function(){that.components.forEach(function(c){c.draw()})},ias.modules.push(that),that}(),ias.graph=function(graph){"use strict";function onCohort(pin,cohort,enter){if(!ias.graph.map.isCohortSelected()){var opacity=enter?.15:.9;pin.parent.selectAll(".pin.cohort:not(."+cohort.cssIdClass+")").style("opacity",opacity)}}function mouseover(pin,d){d.cohorts||onCohort(pin,d,!0)}function mouseout(pin,d){d.cohorts||onCohort(pin,d,!1)}function click(pin,d){d3.event.stopPropagation(),d.cohorts||ias.graph.map.isCohortSelected()!==!1||(onCohort(pin,d,!0),ias.graph.map.select(d))}function match(cohort,filter,groupname){for(var prop in filter)if(filter.hasOwnProperty(prop)&&filter[prop]===!0){if(void 0===cohort.subjects)return!1;if(!cohort.subjects[groupname].has(prop))return!1}return!0}return graph.CountryPin=function(parent,country){this.country=country,this.cohortPins=[],this.pinSize=ias.config.map.cohort.pinSize,this.pinScale=d3.scale.threshold().domain(ias.config.map.cohort.pinScale).range([.125,.25,.375,.5,.625,.75,.865,1]);var cssCohortClass="";this.country.cohorts.forEach(function(coh){coh.cssIdClass="c"+coh.code,cssCohortClass+=" "+coh.cssIdClass}),this.classes="pin country"+cssCohortClass,g2g.GraphComponent.call(this,parent,this.country.centroidx,this.country.centroidy,ias.util.getCountryColor(this.country.id),this.classes)},graph.CountryPin.prototype=Object.create(g2g.GraphComponent.prototype),graph.CountryPin.prototype.filter=function(){var networksFilter=ias.filter.getValue(ias.filter.NETWORKS),statusFilter=ias.filter.getValue(ias.filter.ENROLLMENT_STATUS),yearFilter=ias.filter.getValue(ias.filter.YEAR),ageGroupFilter=ias.filter.getValue(ias.filter.AGE_GROUP),subjectStatusFilter=ias.filter.getValue(ias.filter.SUBJECT_STATUS),that=this;return this.country.cohorts.forEach(function(c){var show=networksFilter[c.getNetwork()];show=show&&("All"===statusFilter||c.status===statusFilter),show=show&&c.year>=yearFilter,show=show&&match(c,ageGroupFilter,"groups"),show=show&&match(c,subjectStatusFilter,"subgroups"),that.g.select("#"+that.country.id+"-"+c.code).style("display",show?"inline":"none")}),this},graph.CountryPin.prototype.zoomAndPan=function(scale,translate){var tt=[translate[0]+this.x*scale,translate[1]+this.y*scale];this.g.attr("transform","translate("+tt.join(",")+")")},graph.CountryPin.prototype.draw=function(){var col,yc,amount,that=this,n=this.country.cohorts.length,xc=(n+1)/2*this.pinSize;return this.g.append("path").attr("d",d3.svg.symbol().type("circle")).style("fill","none").style("stroke-width",.5).style("stroke","gray"),this.country.cohorts.forEach(function(c){col=ias.util.getNetworkColor(c.getNetwork()),xc-=that.pinSize,yc=0,amount=that.pinScale(c.size/1e3);var p=new g2g.Pin(that.g,xc,yc,"",col,"white",that.pinSize,"pin cohort "+c.cssIdClass,amount).on("mouseover",function(){mouseover(that,c)}).on("mouseout",function(){mouseout(that,c)}).on("click",function(){click(that,c)}).draw();p.id(that.country.id+"-"+c.code),that.cohortPins.push(p)}),this},graph}(ias.graph||{}),ias.graph=function(graph){"use strict";return graph.legend=function(svg){function legend1(){drawLegendBackgound(),gbackground.append("rect").attr("class","legend").attr("x",150).attr("y",25).attr("width",20).attr("height",20).style("stroke","#000").style("stroke-width",".3px").style("fill",ias.config.map.background.naColor).attr("dx",-3).attr("dy",".35em"),gbackground.append("text").attr("x",155).attr("y",22).attr("class","legend background").text("na"),gbackground.append("text").attr("x",8).attr("y",22).attr("class","legend background").text("<"),gbackground.append("text").attr("x",10).attr("y",0).attr("id","backgroundInfoTitle").attr("class","title legend").text(ias.config.map.background.HIV.label+" ("+ias.config.map.background.HIV.unit+")"),gbackground.append("text").attr("x",20).attr("y",65).attr("class","title legend").style("font-style","italic").text("Source: AIDSinfo 2011")}function legend2(){var d0,arc,data=ias.config.map.cohort.pinScale,n=data.length,s="";data.forEach(function(d,i){s+=0===i?"< "+d:i===n?"> "+d:d0+" - "+d,gcohort.append("text").attr("y",15+10*i).attr("x",40).attr("class","legend").text(s),d0=d,s="",arc=d3.svg.arc().innerRadius(0).outerRadius(4).startAngle(0).endAngle(.125*2*Math.PI*(i+1)),gcohort.append("path").attr("d",arc).attr("transform","translate(30,"+(12+10*i)+")").style("fill","steelblue").style("stroke","steelblue").style("stroke-width",0),gcohort.append("circle").attr("cx",30).attr("cy",12+10*i).attr("r",4).style("fill","none").style("stroke","steelblue").style("stroke-width",.5)}),gcohort.append("text").attr("x",-20).attr("y",0).attr("class","title legend").text("Cohort Size (K)"),new g2g.Pin(gcohort,0,55,"","gray","white",15,"",.25).draw()}function drawLegendBackgound(){var backgroundInfo=ias.filter.getBackgroundInfoOption(),backgroundConfig=ias.config.map.background[backgroundInfo],rects=gbackground.selectAll("rect.legend.bckg").data(backgroundConfig.bands),texts=gbackground.selectAll("text.legend.bckg").data(backgroundConfig.bands);rects.enter().append("rect").attr("class","legend bckg").attr("y",25).attr("x",function(d,i){return 22*i+15}).attr("width",20).attr("height",20).style("fill",function(d,i){return backgroundConfig.colors[i]}).style("opacity",ias.config.map.background.opacity).style("stroke","#000").style("stroke-width",".3px"),texts.enter().append("text").attr("x",function(d,i){return 22*i+25}).attr("y",22).style("text-anchor","middle").attr("class","legend bckg").text(function(d){return d}),rects.attr("x",function(d,i){return 22*i+15}).style("fill",function(d,i){return backgroundConfig.colors[i]}),texts.attr("x",function(d,i){return 22*i+25}).text(function(d){return d}),rects.exit().remove(),texts.exit().remove()}function draw(){legend1(),legend2()}function update(){}function filterUpdate(){var backgroundInfo=ias.filter.getBackgroundInfoOption(),t=ias.config.map.background[backgroundInfo].label+" ("+ias.config.map.background[backgroundInfo].unit+")";gbackground.select("#backgroundInfoTitle").text(t),drawLegendBackgound()}var posx=10,posy=20,gbackground=svg.append("g").attr("id","blegend").attr("transform","translate("+posx+","+posy+")"),gcohort=svg.append("g").attr("id","clegend").attr("transform","translate("+(posx+240)+","+posy+")");return ias.filter.addListener(ias.filter.BACKGROUND_INFO,filterUpdate),{draw:draw,update:update,filterUpdate:filterUpdate}},graph}(ias.graph||{}),ias.graph=function(graph){"use strict";return graph.map=function(svg){function zoomAndPan(scale,translate){var tt="translate("+translate.join(",")+")",ts="scale("+scale+")";gmap.attr("transform",tt+ts),gmap.selectAll("path").attr("d",ias.graph.path.projection(ias.graph.projection)),countryPins.forEach(function(p){p.zoomAndPan(scale,translate)})}function click(d){var centroid;d3.event.stopPropagation(),d&&(centroid=ias.graph.path.centroid(d),clickOnCountry(d))}function clickOnCountry(d){var countryId=ias.util.getCountryId(d),country=ias.model.allcountriesById[countryId];controller.select(country),gpins_country.selectAll(".pin.cohort").style("opacity",.9)}function clickOnOcean(){controller.reset(),gpins_country.selectAll(".pin.cohort").style("opacity",.9)}function draw(){svg.append("path").datum(d3.geo.graticule()).attr("class","graticule").attr("d",ias.graph.path),svg.on("mousedown",mousedown).on("mouseup",mouseup).on("click",clickOnOcean),gmap.selectAll("path").data(ias.model.worldJson.features).enter().append("path").attr("class","country").attr("d",ias.graph.path).attr("pointer-events","fill").style("fill",function(d){return ias.util.getCountryColorByFeature(d)}).attr("id",function(d){return ias.util.getCountryId(d)}).style("opacity",ias.config.map.background.opacity).on("click",click),gmap.select("#ATA").remove(),ias.model.countriesWithCohorts.forEach(function(country){var pin=new ias.graph.CountryPin(gpins_country,country).draw();countryPins.push(pin),pin.filter()})}function mousedown(){svg.style("cursor","move")}function mouseup(){svg.style("cursor","pointer")}function update(){}function filterUpdate(event){return event===ias.filter.BACKGROUND_INFO?(ias.util.initBackgroundColors(),gmap.selectAll("path").style("fill",function(d){return ias.util.getCountryColorByFeature(d)}),void 0):(countryPins.forEach(function(d){d.filter()}),void 0)}function isCohortSelected(){return controller.getCohort()!==void 0}function createController(){function select(d){return d&&"Cohort"===d.constructor.name?(selectCohort(d),selectCountry(void 0),void 0):d&&"Country"===d.constructor.name?(selectCohort(void 0),selectCountry(d),void 0):void 0}function reset(){selectCohort(void 0),selectCountry(void 0)}function getCohort(){return cohort}function selectCohort(c){if(cohort!==c)if(cohort=c){var newHtml=ias.util.getCohortHtml(cohort);ias.graph.tooltip.cohort.html(newHtml),ias.graph.createSubjectsGraph(cohort.subjects),ias.graph.tooltip.cohort.show()}else ias.graph.tooltip.cohort.hide()}function selectCountry(c){if(country!==c)if(country&&d3.select("#"+country.id).style("stroke","#000").style("stroke-width","0.1px"),country=c){ias.graph.tooltip.country.html(ias.util.getCountryHtml(country)).show();try{d3.select("#"+country.id).style("stroke","darkred").style("stroke-width","0.5px")}catch(err){}}else ias.graph.tooltip.country.hide()}var country,cohort;return{select:select,reset:reset,getCohort:getCohort}}var posx=-60,posy=120,g=svg.append("g").attr("id","mapcontainer").attr("transform","translate("+posx+","+posy+")"),gmap=g.append("g").attr("id","map").attr("class","map"),gpins_country=g.append("g").attr("id","pins_country").attr("class","pin country"),countryPins=[],controller=createController();return ias.filter.addListener([ias.filter.NETWORKS,ias.filter.YEAR,ias.filter.ENROLLMENT_STATUS,ias.filter.BACKGROUND_INFO,ias.filter.AGE_GROUP,ias.filter.SUBJECT_STATUS],filterUpdate),ias.graph.zoom.register(svg,zoomAndPan,[posx,posy]),{draw:draw,update:update,filterUpdate:filterUpdate,select:controller.select,isCohortSelected:isCohortSelected}},graph}(ias.graph||{}),ias.graph=function(graph){"use strict";var humanImages={male:"./images/male_adult.png",female:"./images/female_adult.png"};return graph.createSubjectsGraph=function(subjects){function drawLegend(svg){var data=ias.config.filter.subjectStatus;return svg.append("g").attr("transform","translate(0, 10)").selectAll("text").data(data).enter().append("svg:text").attr("class","label subjects").attr("dy",".35em").attr("x",10).attr("text-anchor","start").attr("y",function(d,i){return 1*i+"em"}).text(function(d){return d}).style("stroke",function(d){return color(d)}),12*data.length}function drawGraph(svg,data,i,offset){var innerRadius=50,outerRadius=70,posy=2.4*outerRadius*i+outerRadius+30+offset,posx=40+outerRadius;data.subjects.map(function(d){return d.name});var g=svg.append("svg:g").attr("transform","translate("+posx+","+posy+")"),arc=d3.svg.arc().outerRadius(innerRadius-10).innerRadius(innerRadius-40),arc2=d3.svg.arc().outerRadius(innerRadius+10).innerRadius(innerRadius-38),arc3=d3.svg.arc().outerRadius(innerRadius+4).innerRadius(innerRadius+2),arc4=d3.svg.arc().outerRadius(innerRadius+22).innerRadius(innerRadius+20),pie=d3.layout.pie().sort(null).value(function(d){return d.total}),garcs=g.selectAll("g.arc").data(pie(data.subjects)).enter().append("g").attr("class","arc");g.append("text").attr("class","title subjects").attr("transform","translate(0,"+(-outerRadius-10)+")").attr("text-anchor","middle").text(data.group.toUpperCase()+": "+data.total),garcs.append("path").attr("d",arc).attr("class","subjects").style("fill",function(d){return color(d.data.name)}),garcs.append("path").attr("d",arc4).attr("class","label subjects").attr("id",function(d,i){return"c"+i});var level2=garcs.append("g").selectAll("path").data(function(d){var pp=d3.layout.pie().sort(null).value(function(o){return o.total}).startAngle(d.startAngle).endAngle(d.endAngle),col=color(d.data.name);return pp([{name:"male",total:d.data.male,color:col},{name:"female",total:d.data.female,color:col}])}).enter().append("g");level2.append("path").attr("class",function(d){return d.data.name+" subjects"}).attr("d",arc2).style("stroke",function(d){return d.data.color}),level2.append("svg:image").attr("xlink:href",function(d){return humanImages[d.data.name]}).attr("x",function(d){return arc3.centroid(d)[0]-7}).attr("y",function(d){return arc3.centroid(d)[1]-20}).attr("width",14).attr("height",30).style("opacity",.8),level2.append("svg:text").attr("class","label subjects").attr("dy",".35em").attr("text-anchor",function(d){return(d.startAngle+d.endAngle)/2>Math.PI?"end":"start"}).attr("x",function(d){return arc4.centroid(d)[0]}).attr("y",function(d){return arc4.centroid(d)[1]}).text(function(d){return d.data.total}).style("stroke",function(d){return d.data.color})}var svg=d3.select("#tooltipsvg").append("svg").attr("width",240).attr("height",subjects?200*Object.keys(subjects).length:100),color=d3.scale.category10();if(subjects){var i=0,offset=drawLegend(svg,subjects);for(var group in subjects.data)subjects.data.hasOwnProperty(group)&&(drawGraph(svg,subjects.data[group],i,offset),i+=1)}else svg.append("g").append("text").attr("x",0).attr("y",10).attr("class","tooltip").text("No subject details.")},graph}(ias.graph||{}),ias.graph=function(graph){"use strict";return graph.title=function(svg){function draw(){g.append("text").attr("x",0).attr("y",0).attr("class","graphtitle").text(ias.config.title)}function update(){}var posx=10,posy=30,g=svg.append("g").style("pointer-events","none").attr("transform","translate("+posx+","+posy+")");return{draw:draw,update:update}},graph}(ias.graph||{}),ias.graph=function(graph){"use strict";return graph.tooltip=function(id,xy,innerHtml,classes){var that={},tooltip=d3.select("body").append("div").attr("class","tooltip "+(classes||"")).attr("id",id).style("left",xy[0]+"px").style("top",xy[1]+"px").style("opacity",0).html(innerHtml);
return that.show=function(){return tooltip.transition().duration(100).style("opacity",1),tooltip.style("pointer-events","all"),that},that.hide=function(){return tooltip.transition().duration(200).style("opacity",0),tooltip.style("pointer-events","none"),that},that.html=function(newHtml){return tooltip.html(newHtml),that},that.style=function(attr,value){return tooltip.style(attr,value),that},that.move=function(xy){return tooltip.style("left",xy[0]+"px").style("top",xy[1]+"px"),that},that},graph}(ias.graph||{}),ias.graph=function(graph){"use strict";return graph.zoom=function(parentSvg){function addButton(name,x,y,opacity){gbuttons.append("image").attr("xlink:href","images/"+name+".png").attr("width",20).attr("height",20).attr("x",x).attr("y",y).attr("id",name).style("cursor","pointer").style("opacity",function(){return opacity?opacity:.2}).style("pointer-events",function(){return opacity?"all":"none"}).on("click",function(){control[name]()})}function draw(){addButton("zoomin",50,20,1),addButton("zoomout",25,20),addButton("moveup",-20,10),addButton("movedown",-20,30),addButton("moveleft",-35,20),addButton("moveright",-5,20),gbuttons.append("text").attr("x",80).attr("y",32).attr("id","zoomFactor").text("scale:1")}function update(){}function register(svg,callback,offset){control=controller(svg,callback,offset)}function zoomed(scale){gbuttons.selectAll("#moveup, #movedown, #moveright, #moveleft, #zoomout").style("opacity",1===scale?"0.2":"1").style("pointer-events",1===scale?"none":"all"),gbuttons.select("#zoomin").style("opacity",6>scale?"1":"0.2").style("pointer-events",6>scale?"all":"none"),gbuttons.select("#zoomFactor").text("scale:"+scale.toFixed(1))}function controller(svg,callback,offset){function zoomOut(){var s=scale,delta=1;2>=s?scale=1:4>=s?(scale=2,delta=2):6>=s&&(scale=4,delta=2),zoom.scale(scale),1===scale?(translate[0]=0,translate[1]=0):(translate[0]+=delta*(width/2-offset[0]),translate[1]+=delta*(height/2-offset[1])),zoom.translate(translate),callback(scale,translate),zoomed(scale)}function zoomIn(){var s=scale,delta=1;2>s?scale=2:4>s?(scale=4,delta=2):6>s&&(scale=6,delta=2),zoom.scale(scale),translate[0]-=delta*(width/2-offset[0]),translate[1]-=delta*(height/2-offset[1]),zoom.translate(translate),callback(scale,translate),zoomed(scale)}function moveUp(){translate[1]-=10,zoom.translate(translate),callback(scale,translate)}function moveDown(){translate[1]+=10,zoom.translate(translate),callback(scale,translate)}function moveRight(){translate[0]+=10,zoom.translate(translate),callback(scale,translate)}function moveLeft(){translate[0]-=10,zoom.translate(translate),callback(scale,translate)}var scale=1,translate=[0,0],width=ias.config.map.width,height=ias.config.map.height,zoom=(ias.graph.projection([0,0]),d3.behavior.zoom().scaleExtent([1,6]).on("zoom",function(){scale=d3.event.scale,translate=d3.event.translate,callback(scale,translate),zoomed(scale)}));return svg.call(zoom),{zoomin:zoomIn,zoomout:zoomOut,moveleft:moveLeft,moveright:moveRight,moveup:moveUp,movedown:moveDown}}var control,posx=50,posy=0,gbuttons=parentSvg.append("g").attr("id","buttons").style("pointer-events","none").attr("transform","translate("+posx+","+posy+")");return{draw:draw,update:update,register:register}},graph}(ias.graph||{}),ias.launchApp();