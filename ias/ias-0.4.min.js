/*! IAS Cipher Interactive Map - v0.4 - 
 * Copyright (c) 2013
 * Gilbert Perrin
 */
var ias={version:"0.4"};ias.app={},ias.util={},ias.model={},ias.filter={},ias.graph={},function(){"use strict";var e,t;t=function(){console&&console.log&&console.log.apply(console,arguments)},ias.util=function(){function n(){function i(i,s){if(e.hasOwnProperty(i))return e[i];var o;return s==="EuroCoord"?o=t:s==="IeDEA"?o=n:o=r,e[i]=o(i),e[i]}function s(t){return e.hasOwnProperty(t)?e[t]:(e[t]=r(t),e[t])}var e={},t=d3.scale.ordinal().range(colorbrewer.Greens[6]),n=d3.scale.ordinal().range(colorbrewer.Purples[6]),r=d3.scale.ordinal().range(colorbrewer.Blues[6]);return{getColor:i,get:s}}function r(){return d3.scale.quantile().domain([0,26]).range(colorbrewer[e.map.background.scheme][e.map.background.maxColors])}var t={networkColor:{}};return t.init=function(){t.networkColor=n(),t.mapColors=r()},t}(),ias.filter=function(){function s(){n.forEach(function(e){e.filterUpdate()})}var t={},n=[],r=[],i;t.backgroundInfo="",t.year=1980,t.viewCountryPins=!1,t.viewCohortPins=!0,t.networks={},t.enrollmentStatus="All";for(i=1980;i<=2013;i++)r.push(i);return t.addListener=function(e){n.push(e)},d3.select("#backgroundInfo").on("change",function(e){var n=this.options[this.selectedIndex].value;t.backgroundInfo=n,s()}),d3.select("#year").on("change",function(e){t.year=parseInt(this.options[this.selectedIndex].value),s()}).selectAll("option").data(r).enter().append("option").attr("value",function(e){return e}).text(function(e){return e}),t.init=function(n){function u(e,t){var n=e.code;return n==="EuroCoord"||n==="IeDEA"||n==="Other"?"network":"network "+t}function a(e,t){return e==="EuroCoord"||e==="IeDEA"||e==="Other"?"white":ias.util.networkColor.getColor(e,t)}function f(e,n){var r=n.code;r==="EuroCoord"||r==="IeDEA"||r==="Other"?d3.selectAll("input.network."+r).each(function(n){d3.select(this).property("checked",e.checked),t.networks[n.code]=e.checked}):t.networks[r]=e.checked,s()}var r=n.networks,i,o;d3.select("#status").on("change",function(e){t.enrollmentStatus=this.options[this.selectedIndex].value,s()}).selectAll("option").data(e.filter.status).enter().append("option").attr("value",function(e){return e}).text(function(e){return e}),["EuroCoord","IeDEA","Other"].forEach(function(e,n){i=r[n].children,i.forEach(function(e){t.networks[e.code]=!0}),i.unshift({code:e,name:e}),o=d3.select("#"+e).selectAll("div").data(i).enter().append("div").attr("class",function(t){return e!==t.code?"subnetwork":"network"}),o.append("input").attr("checked",!0).attr("class",function(t){return u(t,e)}).attr("type","checkbox").attr("id",function(e){return"n"+e.code}).on("click",function(e){return f(this,e)}),o.append("span").attr("class","network").style("background",function(t){return a(t.code,e)}).style("color",function(t){return a(t.code,e)}).text(" . "),o.append("label").attr("class",function(t){return e===t.code?"network title":"network"}).attr("for",function(e){return"n"+e.code}).text(function(e){return e.name}),e!=="Other"&&o.append("br")})},t}(),ias.model=function(){function o(e){var t=Object.create(r);t.feature=e,t.cohorts=[],n.allcountries.push(t),n.allcountriesByName[t.name()]=t,n.allcountriesById[t.id()]=t}function u(e){var r=Object.create(s);r.status=e.status,r.code=e.code,r.name=e.name,r.objectives=e.objectives,r.year=e.year,r.size=e.size,r.countryData={},e.countries.forEach(function(i){var s=n.allcountriesByName[i];s?(r.addCountryData(s.id(),10),s.cohorts.push(r),s.networks=[],s.networks.push(e.networks)):t("no country found for "+i)}),r.networks=e.networks,n.cohorts.push(r)}var n={};n.worldJson={},n.networks={},n.allcountries=[],n.allcountriesByName={},n.allcountriesById={},n.countriesWithCohorts=[],n.cohorts=[],n.hivRatesRange=[];var r={feature:{},networks:[],cohorts:[],hivPrevalenceRate:undefined,arvCoverageRate:undefined,id:function(){return this.feature.id},name:function(){return this.feature.properties.name},numberOfCohorts:function(){return this.cohorts?this.cohorts.length:0},html:function(){var e="<span class='tooltip title'>Country</span><h1 class='tooltip'>"+this.name()+"</h1><table>",t="white";return e+="<tr><td class='firstcol'>HIV Prevalence Rate</td><td class='secondcol'>"+(this.hivPrevalenceRate||"na")+" %</td></tr>",e+="<tr><td>ARV Coverage Rate</td><td class='secondcol'>"+(this.arvCoverageRate||"na")+" %</td></tr>",this.cohorts&&this.cohorts.length>0&&(e+="<tr><td colspane='2'><br><b>COHORTS:</b></td></tr>",this.cohorts.forEach(function(n){t=ias.util.networkColor.get(n.networks[0]),e+="<tr><td class='firstcol'><span style='background:"+t+";'>&nbsp;&nbsp;&nbsp;</span>&nbsp;"+n.name+"</td><td class='secondcol'>"+n.size+"</td></tr>"})),e+="</table>",e}},i={countryId:"",size:0},s={status:"",code:"",name:"",year:1980,objectives:"",size:0,networks:[],countryData:{},numberOfCountries:0,getCountryData:function(e){return this.countryData[e]},addCountryData:function(e,t){var n=Object.create(i);n.countryId=e,n.size=t,this.countryData[e]=n,this.numberOfCountries+=1},html:function(){var t="<span class='tooltip title'>Cohort</span><h1 class='tooltip'>"+this.name+":</h1>",r="white",i,s,o;t+="<div id='ctooltippin'></div>&nbsp;"+this.size+" subjects ",t+="&nbsp;<span style='background:"+ias.util.networkColor.get(this.networks[0])+";'>&nbsp;&nbsp;&nbsp;</span>&nbsp"+this.networks[0],t+="<br><br><b>Status:</b>&nbsp;"+this.status+"<br>",t+="<br><b>Objectives:</b><br>",t+="<span class='tooltip objectives'>"+this.objectives+"</span>",t+="<br><br><b>Countries:</b><br><table>";for(o in this.countryData)i=n.allcountriesById[o],s=i.hivPrevalenceRate,r=ias.util.mapColors(s),t+="<tr><td class='firstcol'><span style='background:"+r+";'>&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;"+i.name()+"</td></tr>";return t+="</table>",t+="<br><br><a class='tooltip' target='_blank' href='"+e.map.cohort.fullProfile.replace("$code$",this.code)+"'>View Full Profile</a>",t}};return n.init=function(e,r,i,s){n.worldJson=e,n.networks=r.networks,n.worldJson.features.forEach(function(e){o(e)}),s.forEach(function(e){var r=n.allcountriesByName[e.country];r!==undefined?(r.hivPrevalenceRate=parseFloat(e.rate),n.hivRatesRange.push(e.rate)):t("no country found for "+e.country)}),ias.util.mapColors.domain(n.hivRatesRange),i.cohorts.forEach(function(e){u(e)}),n.allcountries.forEach(function(e){e.numberOfCohorts()>0&&n.countriesWithCohorts.push(e)})},n.getCountry=function(e){var t=n.allcountriesByName[e];return t},n}(),ias.graph=function(){function c(e){var t=ias.model.allcountriesById[e];a.html(t.html()).show(),d3.select("#"+e).style("stroke","steelblue").style("stroke-width","1px")}function h(e){a.hide(),d3.select("#"+e).style("stroke","#fff").style("stroke-width","0px")}function p(){if(d3.event.scale>=4){d3.event.scale=4;return}d3.event.scale>=1&&d3.event.scale<=4&&d3.select("#mapcontainer").attr("transform","translate("+d3.event.translate+")"+" scale("+d3.event.scale+")")}var t={},n=Math.PI,r=d3.geo.equirectangular().scale(140),i=d3.geo.path().projection(r),s={},o={},u=[],a={},f={},l;t.components=[];var d=function(e,t,n,r){var i={},s=d3.select("body").append("div").attr("class","tooltip "+(r||"")).attr("id",e).style("left",t[0]+"px").style("top",t[1]+"px").style("opacity",0);return s.html(n),i.show=function(){return s.transition().duration(100).style("opacity",1),i},i.hide=function(){return s.transition().duration(200).style("opacity",0),i},i.html=function(e){return s.html(e),i},i.style=function(e,t){return s.style(e,t),i},i.move=function(e){return s.style("left",e[0]+"px").style("top",e[1]+"px"),i},i},v=function(t,r,i){function N(e){return e==="All"||r.status===e}function C(){l!==undefined&&l!==s&&(l.exit(!0),l=undefined);if(l===undefined||l!==s)T?T.select(!0):s.select(!0),c(s.country.id()),k()}function k(){f.html(s.cohort.html()).show(),d3.select("#ctooltippin").append("svg").attr("class","tooltip").append("g").attr("transform","translate(6, 6)").append("path").attr("class","").style("fill",e.map.cohort.pincolor,"opacity",1).attr("d",E)}var s={cohort:r,country:i},o=r.getCountryData(i.id()),u=ias.util.networkColor.get(r.networks[0]),a=d3.scale.linear().domain([0,2e5]).range([5,30]),p=a(r.size),d=o.x,v=o.y,m=e.map.cohort.pinsize,g=2*m,y=3*m,b=t.append("g").attr("class","pin cohort").attr("transform","translate("+d+","+v+")"),w=d3.svg.arc().innerRadius(0).outerRadius(m/2).startAngle(0).endAngle(r.size/e.map.cohort.limit*2*n),E=d3.svg.arc().innerRadius(0).outerRadius(6).startAngle(0).endAngle(r.size/e.map.cohort.limit*2*n),S=d3.svg.symbol().type(e.map.cohort.pinsymbol).size(4),x=b.append("circle").attr("cx",0).attr("cy",0).style("fill",u).style("display","none").style("opacity","0.7").attr("r",m),T;return s.exit=function(e){if(e||l===undefined||l!==s)T?T.select(!1):s.select(!1),h(s.country.id()),f.hide()},s.filter=function(){var e=ias.filter.networks[r.networks[0]];return e=e&&N(ias.filter.enrollmentStatus),s.setVisible(e),s},s.getXY=function(){return{x:d,y:v}},s.addLink=function(e){T=e},s.setVisible=function(e){return b.style("display",e?"inline":"none"),s},s.getNode=function(){return b},s.getColor=function(){return u},s.select=function(e){x.style("display",e?"inline":"none")},s.draw=function(){return b.append("circle").attr("cx",0).attr("cy",0).attr("class","pin").style("fill","white","opacity",.7).attr("r",m/2),b.append("circle").attr("cx",0).attr("cy",0).style("fill","none","opacity",1).style("stroke",e.map.cohort.pincolor).style("stroke-width","1px").attr("r",m/2),b.append("path").attr("class","").style("fill",e.map.cohort.pincolor,"opacity",1).attr("d",w),b.append("path").style("fill",u,"opacity",1).attr("transform","translate(0,-4)").attr("d",S),b.on("mouseover",function(e){C()}),b.on("mouseout",function(e){s.exit(!1)}),b.on("click",function(e){if(l===s)return;l=s}),s},s},m=function(t,n){var r={elements:[],color:n,closed:!1},i=[],s=d3.svg.area().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(e.map.cohort.link.interpolate),o=t.append("g").attr("class","link cohort").style("display","none");return r.add=function(e){var t=e.getXY();r.elements.push(e),i.push(t),i.sort(function(e,t){return e.y-t.y})},r.select=function(e){r.setVisible(e),r.elements.forEach(function(t){t.select(e)})},r.setVisible=function(e){return o.style("display",e?"inline":"none"),r},r.close=function(){if(r.closed)return;return i.push(r.elements[0].getXY()),r.closed=!0,r},r.draw=function(){return o.append("path").attr("d",s(i)).style("stroke-width",.5).style("stroke",e.map.cohort.pincolor).style("fill","none"),r},r},g=function(){function d(s){var u=0,a=0,f=t,l=n,c=1,h;s&&r!==s?(h=i.centroid(s),u=-h[0],a=-h[1],c=3,f=u+e.map.width/2/c,l=a+e.map.height/2/c,r=s):r=null,o.transition().duration(1e3).attr("transform","scale("+c+") translate("+f+","+l+")").style("stroke-width",1.5/c+"px")}function g(e){var t=ias.model.getCountry(e.properties.name),n=t.hivPrevalenceRate;return n!==undefined?ias.util.mapColors(n):"gray"}function y(){var t={},n={},r;a.selectAll("path").data(ias.model.worldJson.features).enter().append("path").attr("class","country").attr("d",i).style("fill",function(e){return g(e)}).attr("id",function(e){return e.id}).on("mouseover",function(e){c(e.id)}).on("mouseout",function(e){h(e.id)}).style("opacity",e.map.background.opacity).on("click",d),a.select("#ATA").remove(),ias.model.countriesWithCohorts.forEach(function(e){var n=e.numberOfCohorts(),r={};n>0&&e.cohorts.forEach(function(n){r=v(p,n,e).draw(),t[n.code]===undefined?t[n.code]=[r]:t[n.code].push(r),u.push(r)})});for(r in t)t[r].length>1&&(n=m(l,t[r][0].getColor()),t[r].forEach(function(e){n.add(e),e.addLink(n)}),n.draw())}function b(){}function w(){f.style("display",ias.filter.viewCountryPins?"inline":"none"),p.style("display",ias.filter.viewCohortPins?"inline":"none"),u.forEach(function(e){e.filter()})}var t=-100,n=-20,r,o=s.append("g").attr("id","mapcontainer").attr("transform","translate("+t+","+n+")"),a=o.append("g").attr("id","map").attr("class","map"),f=o.append("g").attr("id","pins_country").attr("class","pin country").style("display",ias.filter.viewCountryPins?"inline":"none"),l=o.append("g").attr("id","links_cohort").attr("class","link cohort"),p=o.append("g").attr("id","pins_cohort").attr("class","pin cohort");return{draw:y,update:b,filterUpdate:w}},y=function(){function a(){var t=ias.util.mapColors.quantiles(),r=ias.util.mapColors.range().length;i.selectAll("rect").data(t).enter().append("rect").attr("class","legend").attr("x",function(e,t){return t*20+10}).attr("y",20).attr("width",20).attr("height",20).style("stroke","#000").style("stroke-width",".3px").style("fill",function(e){return ias.util.mapColors(e)}).style("opacity",e.map.background.opacity).attr("dx",-3).attr("dy",".35em"),i.append("rect").attr("class","legend").attr("x",(r-1)*20+15).attr("y",20).attr("width",20).attr("height",20).style("stroke","#000").style("stroke-width",".3px").style("fill","gray").attr("dx",-3).attr("dy",".35em"),t.push("n/a"),i.selectAll("text").data(t).enter().append("text").attr("x",function(e,t){return t*20+(e!=="n/a"?10:15)}).attr("y",18).attr("class","legend").text(function(e){return e!=="n/a"?">"+parseFloat(e).toFixed(1):e}),i.append("text").attr("x",10).attr("y",8).attr("class","title legend").text("HIV Prevalence Rate (%)");var o=[e.map.cohort.limit/6],a=0;for(a=1;a<=4;a++)o[a]=e.map.cohort.limit*a/4;s.selectAll("circle").data(o).enter().append("circle").attr("cx",function(e,t){return t*26+17}).attr("cy",30).style("fill","none","opacity",1).style("stroke",e.map.cohort.pincolor).style("stroke-width","4px").attr("r",9),s.selectAll("path").data(o).enter().append("path").attr("class","").attr("transform",function(e,t){return"translate("+(t*26+17)+",30)"}).style("fill",e.map.cohort.pincolor,"opacity",1).attr("d",u.endAngle(function(t){return t/e.map.cohort.limit*2*n})),s.selectAll("text").data(o).enter().append("text").attr("x",function(e,t){return t*26+4}).attr("y",18).attr("class","legend").text(function(e,t){return t===4?">"+e:e}),i.append("text").attr("x",200).attr("y",8).attr("class","title legend").text("Cohort Size")}function f(){}function l(){}var t=0,r=20,i=o.append("g").attr("id","blegend").attr("transform","translate("+t+","+r+")"),s=o.append("g").attr("id","clegend").attr("transform","translate("+(t+200)+","+r+")"),u=d3.svg.arc().innerRadius(0).outerRadius(8).startAngle(0);return{draw:a,update:f,filterUpdate:l}};return t.init=function(n){s=d3.select("#map").append("svg").attr("width",e.map.width).attr("height",e.map.height),o=d3.select("#legend").append("svg").attr("width",e.legend.width).attr("height",e.legend.height),t.map=g(),t.components.push(t.map),t.legend=y(),t.components.push(t.legend);var u={};n.forEach(function(e){u[e.id]=e.ll}),a=d("tooltipCountry",e.map.tooltip.country,"","country"),f=d("tooltipCohort",e.map.tooltip.cohort,"","cohort"),ias.model.countriesWithCohorts.forEach(function(t){var n=[],s=u[t.name()],o,a,f,l;s===undefined?n=i.centroid(t.feature):n=r(s),t.centroidx=n[0],t.centroidy=n[1],t.cohorts.length===1?(o=t.cohorts[0].getCountryData(t.id()),o.x=n[0],o.y=n[1]):(l=t.cohorts.length,a=d3.scale.linear().domain([0,l]).range([-l/2,l/2]),t.cohorts.forEach(function(r,i){o=r.getCountryData(t.id()),f=a(i)*(e.map.cohort.pinsize+1),o.x=n[0]+f,o.y=n[1]}))}),t.components.forEach(function(e){ias.filter.addListener(e)})},t}(),ias.app=function(){function r(){ias.graph.components.forEach(function(e){e.update()})}function i(n,i,s,o,u,a,f){n&&t(n),e=i,ias.util.init(),ias.filter.init(u),ias.model.init(s,u,a,f),ias.graph.init(o),ias.graph.components.forEach(function(e){e.draw()}),r()}var n={};return n.load=function(){queue().defer(d3.json,"/ias-config.json").defer(d3.json,"/data/world-countries.json").defer(d3.json,"/data/centroids.json").defer(d3.json,"/data/ias-networks.json").defer(d3.json,"/data/ias-cohorts.json").defer(d3.csv,"/data/hiv-prevalence-rate.csv").await(i)},n}(),ias.app.load()}();