/*! ias 2013-04-19 */
var g2g_info={version:"v0.1"},g2g=function(t){"use strict";return t.GraphComponent=function(t,e,n,r,o){this.x=e,this.y=n,this.color=r,this.parent=t,this.g=t.append("g").attr("transform","translate("+e+","+n+")"),o&&this.g.attr("class",o)},t.GraphComponent.prototype.getXY=function(){return{x:this.x,y:this.y}},t.GraphComponent.prototype.setVisible=function(t){return this.g.style("display",t?"inline":"none"),this},t.GraphComponent.prototype.getNode=function(){return this.g},t.GraphComponent.prototype.draw=function(){return this},t.GraphComponent.prototype.select=function(){return this},t.GraphComponent.prototype.id=function(t){return this.g.attr("id",t),this},t.GraphComponent.prototype.on=function(t,e){return this.g.on(t,e),this},t.GraphComponent.prototype.moveOnTop=function(){return this.parent.appendChild(this),this},t.Link=function(e,n,r,o){t.GraphComponent.call(this,e,0,0,r,o),this.elements=[],this.closed=!1;var a=d3.svg.area().x(function(t){return t.x}).y(function(t){return t.y}).interpolate(n),i=[];this.path=function(){return a(i)},this.addElement=function(t){var e=t.getXY();return this.elements.push(t),i.push(e),i.sort(function(t,e){return t.y-e.y}),this},this.close=function(){return this.closed?void 0:(i.push(this.elements[0].getXY()),this.closed=!0,this)}},t.Link.prototype=Object.create(t.GraphComponent.prototype),t.Link.prototype.select=function(t){return this.setVisible(t),this.elements.forEach(function(e){e.select(t)}),this},t.Link.prototype.draw=function(){return this.g.append("path").attr("d",this.path()).style("stroke",this.color),this},t.Options=function(t){if(this.listeners={},t){var e;for(e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}},t.Options.prototype.addListener=function(t,e){var n=Array.isArray(t)?t:[t],r=this;n.forEach(function(t){r.listeners.hasOwnProperty(t)===!1&&(r.listeners[t]=[]),e&&"function"==typeof e&&r.listeners[t].push(e)})},t.Options.prototype.getValue=function(t){return this.hasOwnProperty(t)?this[t]:void 0},t.Options.prototype.change=function(t,e){var n,r,o,a,i=t;if(t.indexOf(".")>0?(n=t.split("."),i=n[0],r=this[i][n[1]]):r=this[i],this.hasOwnProperty(i)&&r!==e&&(n?this[i][n[1]]=e:this[i]=e,this.listeners.hasOwnProperty(i)))for(a=this.listeners[i],o=0;a.length>o;o+=1)a[o].call(this,i)},t.Pin=function(e,n,r,o,a,i,s,c,l){t.GraphComponent.call(this,e,n,r,a,c),this.text=o,this.color1=a,this.color2=i,this.size=s,this.x=n,this.y=r,this.amount=l},t.Pin.prototype=Object.create(t.GraphComponent.prototype),t.Pin.prototype.draw=function(){var t=Math.PI,e=this.size/2,n=4*e,r=d3.svg.arc().innerRadius(0).outerRadius(e).startAngle(t/2).endAngle(-t/2),o=d3.svg.arc().innerRadius(0).outerRadius(e-4).startAngle(0).endAngle(2*t*this.amount);return this.g.append("path").attr("class","pin").attr("d",r).attr("transform","translate(0, +1)").style("fill",this.color1).style("stroke-width",0),this.g.append("path").attr("class","pin").attr("d",function(){return"M "+-e+" 0 l "+2*e+" 0 l "+-e+" "+n+" z"}).style("fill",this.color1).style("stroke-width",0),this.g.append("circle").attr("cx",0).attr("cy",0).attr("class","pin").style("fill",this.color2).attr("r",e-3).style("stroke-width",0).style("opacity",1),this.g.append("path").attr("d",o).style("fill","steelblue").style("stroke-width",0),this.g.append("text").attr("dx",0).attr("dy","0.35em").attr("class","pin").style("text-anchor","middle").text(this.text),this.g.attr("transform","translate("+this.x+","+(this.y+-n)+")"),this},t}(g2g_info),ias_info={mode:"offline",modules:[],config:{}},ias=function(t){"use strict";function e(e,n,r,o,a,i){var s;if(e)throw s="Error while loading data: "+e.message,t.showError(s),s;try{t.modules.forEach(function(t){t.init({world:n,centroids:r,networks:o,cohorts:a,unaidsinfo:i})}),t.modules.forEach(function(t){t.hasOwnProperty("run")&&t.run()}),t.showError()}catch(c){throw t.showError("Error while initializing IAS modules: "+c),c}}function n(e,n,r){var o;if(e)throw o="Error while loading data: "+e.message,t.showError(o),o;try{t.modules.forEach(function(t){t.update({networks:n,cohorts:r})}),t.showError()}catch(a){throw t.showError("Error while updating IAS modules: "+a),a}}return t.log=function(){console&&console.log&&console.log.apply(console,arguments)},t.showError=function(){d3.select("#error").text(arguments?arguments[0]:"")},t.launchApp=function(){return d3.json("./ias-config.json",function(e,n){if(e)throw"Error while loading configuration file: "+e.message;t.config=n;var r=window.top.location.search.replace("?","").split("=");t.mode=2===r.length&&"mode"===r[0]?r[1].replace("/",""):"offline",d3.select("#mode").text(t.mode+" mode"),t.loadData(t.mode)}),t},t.loadData=function(n){return queue().defer(d3.json,t.config.data.mapGeoJson).defer(d3.json,t.config.data.mapCentroids).defer(d3.json,t.config.data[n+"Networks"]).defer(d3.json,t.config.data[n+"Cohorts"]).defer(d3.json,t.config.data[n+"UnaidsInfo"]).await(e),t},t.reloadData=function(e){return queue().defer(d3.json,t.config.data[e+"Networks"]).defer(d3.json,t.config.data[e+"Cohorts"]).await(n),t},t}(ias_info);ias.util=function(){"use strict";var t={},e=d3.scale.quantile(),n={},r={};return t.getNetworkColor=function(t){return n.hasOwnProperty(t)?n[t]:"white"},t.getCountryColor=function(e){var n=ias.model.getCountryById(e),r=n[ias.filter.getBackgroundInfoOption()];return t.getBackgroundColor(r)},t.getBackgroundColor=function(t){return isNaN(t)?ias.config.map.background.naColor:e(t)},t.getSelectedDomainRates=function(){return r[ias.filter.getBackgroundInfoOption()]},t.getCountryColorByFeature=function(e){var n=ias.model.getCountry(e.properties.name),r=n[ias.filter.getBackgroundInfoOption()];return t.getBackgroundColor(r)},t.getCountryId=function(t){var e=t.id;return"-99"===e?"9"+t.properties.name.substring(0,2):t.id},t.getCohortHtml=function(t){var e="<span class='tooltip title'>Cohort</span><h1 class='tooltip'>"+t.name+":</h1>";return e+="<b>Number of subjects:</b>&nbsp;"+t.size+"<br>",e+="<b>Network:&nbsp;</b>"+t.getNetwork()+"<br>",e+="<b>Status:</b>&nbsp;"+t.status+"<br>",e+="<b>Countries:</b>&nbsp;",e+=t.getCountries().map(function(t){return t.name}).join(", ")+"<br><br>",e+="<b>Objectives:&nbsp;</b>",e+="<span class='tooltip objectives'>"+t.objectives+"</span>",e+="<br><br><a class='tooltip' target='_blank' href='"+ias.config.map.cohort.fullProfile.replace("$code$",t.code)+"'>View Full Profile</a><br><br>",e+="<b>Subjects:&nbsp;</b>",e+="<br><div id='tooltipsvg'></div>"},t.getCountryHtml=function(t){var e="<span class='tooltip title'>Country   "+t.id+"</span><h1 class='tooltip'>"+t.name+"</h1><table>",n="white";return e+="<tr><td class='firstcol'>HIV Prevalence Rate</td><td class='secondcol'>",e+=(t.hivPrevalenceRate||"na")+" %</td></tr>",e+="<tr><td>ARV Coverage Rate</td><td class='secondcol'>",e+=(t.arvCoverageRate||"na")+" %</td></tr>",t.cohorts&&t.cohorts.length>0&&(e+="<tr><td colspane='2'><br><b>COHORTS:</b></td></tr>",t.cohorts.forEach(function(t){n=ias.util.getNetworkColor(t.networks[0]),e+="<tr><td class='firstcol'><span style='background:",e+=n+";'>&nbsp;&nbsp;&nbsp;</span>&nbsp;",e+=t.name+"</td><td class='secondcol'>",e+=t.size+"</td></tr>"}),e+="<tr><td class='firstcol' style='text-align:right;'><b>Total</b></td><td class='secondcol'><b>",e+=t.size+"</b></td></tr>"),e+="</table>"},t.init=function(e){var o,a,i;a=e.networks.map(function(t){return t.code}),i=d3.scale.category20c().domain(a),a.forEach(function(t){n[t]=i(t)}),o=e.unaidsinfo.filter(function(t){return!isNaN(t.hiv)}).map(function(t){return parseFloat(t.hiv)}),r.hivPrevalenceRate=[d3.min(o),d3.max(o)],o=e.unaidsinfo.filter(function(t){return!isNaN(t.arv)}).map(function(t){return parseFloat(t.arv)}),r.arvCoverageRate=[d3.min(o),d3.max(o)],t.initBackgroundColors()},t.initBackgroundColors=function(){var t=ias.config.map.background[ias.filter.getBackgroundInfoOption()];e.domain(t.bands),e.range(t.colors)},t.update=function(){},ias.modules.push(t),t}(),ias.filter=function(){"use strict";function t(t,e){var n=d3.select("#"+t).selectAll("input").data(e).enter().append("div");n.append("input").attr("checked",!0).attr("type","checkbox").attr("id",function(e){return t+e}).attr("value",function(t){return t}).attr("selected","selected"),n.append("label").attr("for",function(e){return t+e}).attr("class",t).text(function(t){return t})}var e,n,r={},o={},a=[],i={};for(e=1980;2013>=e;e+=1)a.push(e);return r.BACKGROUND_INFO="backgroundInfo",r.YEAR="year",r.NETWORKS="networks",r.ENROLLMENT_STATUS="enrollmentStatus",r.AGE_GROUP="ageGroup",i[r.BACKGROUND_INFO]="hivPrevalenceRate",i[r.YEAR]="1980",i[r.NETWORKS]={},i[r.ENROLLMENT_STATUS]="All",i[r.AGE_GROUP]="All",n=new g2g.Options(i),r.getValue=function(t){return n.getValue(t)},r.getBackgroundInfoOption=function(){return r.getValue(r.BACKGROUND_INFO)},r.addListener=function(t,e){n.addListener(t,e)},d3.select("#backgroundInfo").on("change",function(){var t=this.options[this.selectedIndex].value;n.change(r.BACKGROUND_INFO,t)}),d3.select("#year").on("change",function(){var t=parseInt(this.options[this.selectedIndex].value,10);n.change(r.YEAR,t)}).selectAll("option").data(a).enter().append("option").attr("value",function(t){return t}).text(function(t){return t}),r.init=function(e){function a(t,e){var o=e.code;n.change(r.NETWORKS+"."+o,t.checked)}var i;o=ias.config.filter,d3.select("#mapInfo").text("version: "+ias.config.version+" - "+ias.config.timestamp+"  ("+ias.mode+")"),d3.select("#status").on("change",function(){var t=this.options[this.selectedIndex].value;n.change(r.ENROLLMENT_STATUS,t)}).selectAll("option").data(o.enrollmentStatus).enter().append("option").attr("value",function(t){return t}).text(function(t){return t}),t("ageGroup",o.ageGroup),t("subjectStatus",o.subjectStatus),e.networks.sort(function(t,e){return d3.ascending(t.code,e.code)});var s=Math.round(e.networks.length/2),c=[e.networks.slice(0,s),e.networks.slice(s,e.networks.length)];c.forEach(function(t,e){t.forEach(function(t){n.networks[t.code]=!0}),i=d3.select("#net"+(e+1)).selectAll("div").data(t).enter().append("div").attr("class","network"),i.append("input").attr("checked",!0).attr("class","network").attr("type","checkbox").attr("id",function(t){return"n"+t.code}).on("click",function(t){return a(this,t)}),i.append("span").text("__").style("color",function(t){return ias.util.getNetworkColor(t.code)}).style("background",function(t){return ias.util.getNetworkColor(t.code)}),i.append("label").attr("class","network").attr("for",function(t){return"n"+t.code}).text(function(t){return" "+t.name})})},r.update=function(){},ias.modules.push(r),r}(),ias.model=function(){"use strict";var t={worldJson:{},networks:{},allcountries:[],allcountriesByName:{},allcountriesById:{},countriesWithCohorts:[],cohorts:[]};return t.getCountry=function(e){var n=t.allcountriesByName[e];return n},t.getCountryById=function(e){var n=t.allcountriesById[e];return n},t.init=function(e){t.worldJson=e.world,t.networks=e.networks.children,t.worldJson.features.forEach(function(e){var n=new ias.model.Country(e);t.allcountries.push(n),t.allcountriesByName[n.name]=n,t.allcountriesById[n.id]=n}),e.unaidsinfo.forEach(function(e){var n=t.allcountriesByName[e.name];void 0!==n?(n.hivPrevalenceRate=parseFloat(e.hiv),n.arvCoverageRate=parseFloat(e.arv)):ias.log("HIV/ARV Rates: no country found for "+e.name)}),e.cohorts.forEach(function(e){var n=new ias.model.Cohort(e);t.cohorts.push(n)}),t.allcountries.forEach(function(e){e.numberOfCohorts()>0&&t.countriesWithCohorts.push(e)})},t.update=function(){},ias.modules.push(t),t}(),ias.model=function(t){"use strict";return t.Cohort=function(e){this.status=e.status,this.code=e.code,this.name=e.name,this.subjects=e.subjects,this.objectives=e.objectives,this.year=e.year,this.size=e.size,this.networks=e.networks,this.countryData={};var n=this;e.countries.forEach(function(r){var o=t.allcountriesById[r.trim()];o?(n.addCountryData(o.id,10,o),o.addCohort(n),o.addNetwork(e.networks[0])):ias.log("Cohort country not found for "+r)})},t.Cohort.prototype.getCountryData=function(t){return this.countryData[t]},t.Cohort.prototype.getCountries=function(){var t=[];for(var e in this.countryData)this.countryData.hasOwnProperty(e)&&t.push(this.countryData[e].country);return t},t.Cohort.prototype.getCountryIds=function(){return Object.keys(this.countryData)},t.Cohort.prototype.addCountryData=function(t,e,n){var r=Object.create(ias.model.CountryData);r.countryId=t,r.size=e,r.country=n,this.countryData[t]=r,this.numberOfCountries+=1},t.Cohort.prototype.getNetwork=function(){return this.networks[0]},t.Cohort.prototype.getSubjects=function(){if(this.subjects){var t={groups:d3.map(),subgroups:d3.map(),data:{}};return this.subjects.forEach(function(e){t.subgroups.set(e.subgroup,e.subgroup),t.groups.set(e.group,e.group),e.group in t.data?(t.data[e.group].subjects.push({name:e.subgroup,total:e.male+e.female,male:e.male,female:e.female}),t.data[e.group].total+=e.male+e.female):t.data[e.group]={group:e.group,total:e.male+e.female,subjects:[{name:e.subgroup,total:e.male+e.female,male:e.male,female:e.female}]}}),t}return void 0},t}(ias.model||{}),ias.model=function(t){"use strict";return t.Country=function(t){this.feature=t,this.networks={},this.cohorts=[],this.hivPrevalenceRate="na",this.arvCoverageRate="na",this.size=0,this.id=t.id,"-99"===this.id&&(this.id="9"+t.properties.name.substring(0,2)),this.name=this.feature.properties.name},t.Country.prototype.addNetwork=function(t){this.networks.hasOwnProperty(t)===!1&&(this.networks[t]=t)},t.Country.prototype.getNetworks=function(){return Object.keys(this.networks)},t.Country.prototype.numberOfCohorts=function(){return this.cohorts?this.cohorts.length:0},t.Country.prototype.addCohort=function(t){return this.cohorts.push(t),this.size+=t.size,this},t.Country.prototype.getCohortIds=function(){var t=[];return this.cohorts&&this.cohorts.length>0&&this.cohorts.forEach(function(e){t.push(e.code)}),t},t}(ias.model||{}),ias.model=function(t){"use strict";return t.CountryData={countryId:"",size:0,country:null},t}(ias.model||{}),ias.graph=function(){"use strict";var t={components:[],tooltip:{country:{},cohort:{}}};return t.projection=d3.geo.miller().precision(.1).scale(153),t.path=d3.geo.path().projection(t.projection),t.init=function(e){var n,r,o,a,i={};n=d3.select("#map").append("svg").attr("class","map").attr("width",ias.config.map.width).attr("height",ias.config.map.height),r=d3.select("#legend").append("svg").attr("class","legend").attr("width",ias.config.legend.width).attr("height",ias.config.legend.height),o=d3.select("#title").append("svg").attr("class","title").attr("width",360).attr("height",50),a=d3.select("#zoom").append("svg").attr("class","zoom").attr("width",180).attr("height",60),t.zoom=ias.graph.zoom(a),t.components.push(t.zoom),t.map=ias.graph.map(n),t.components.push(t.map),t.legend=ias.graph.legend(r),t.components.push(t.legend),t.components.push(ias.graph.title(o)),e.centroids.forEach(function(t){i[t.id]=t.ll}),t.tooltip.country=ias.graph.tooltip("tooltipCountry",ias.config.map.tooltip.country,"","country"),t.tooltip.cohort=ias.graph.tooltip("tooltipCohort",ias.config.map.tooltip.cohort,"","cohort"),ias.model.countriesWithCohorts.forEach(function(e){var n=[],r=i[e.name];n=r===void 0?t.path.centroid(e.feature):t.projection(r),e.centroidx=n[0],e.centroidy=n[1]})},t.update=function(){},t.run=function(){t.components.forEach(function(t){t.draw()})},ias.modules.push(t),t}(),ias.graph=function(t){"use strict";function e(t,e,n){var r=n?.15:.9;t.parent.selectAll(".pin.cohort:not(."+e.cssIdClass+")").style("opacity",r)}function n(t,n){n.cohorts||e(t,n,!0)}function r(t,n){n.cohorts||e(t,n,!1)}function o(t,n){d3.event.stopPropagation(),n.cohorts||(ias.graph.map.select(n),e(t,n,!0))}return t.CountryPin=function(t,e){this.country=e,this.cohortPins=[],this.pinSize=ias.config.map.cohort.pinSize,this.pinScale=d3.scale.threshold().domain(ias.config.map.cohort.pinScale).range([.125,.25,.375,.5,.625,.75,.865,1]);var n="";this.country.cohorts.forEach(function(t){t.cssIdClass="c"+t.code,n+=" "+t.cssIdClass}),this.classes="pin country"+n,g2g.GraphComponent.call(this,t,this.country.centroidx,this.country.centroidy,ias.util.getCountryColor(this.country.id),this.classes)},t.CountryPin.prototype=Object.create(g2g.GraphComponent.prototype),t.CountryPin.prototype.filter=function(){var t=ias.filter.getValue(ias.filter.NETWORKS),e=ias.filter.getValue(ias.filter.ENROLLMENT_STATUS),n=this;return this.country.cohorts.forEach(function(r){var o=t[r.getNetwork()];o&="All"===e||r.status===e,n.g.select("#"+n.country.id+"-"+r.code).style("display",o?"inline":"none")}),this},t.CountryPin.prototype.zoomAndPan=function(t,e){var n=[e[0]+this.x*t,e[1]+this.y*t];this.g.attr("transform","translate("+n.join(",")+")")},t.CountryPin.prototype.draw=function(){var t,e,a,i=this,s=this.country.cohorts.length,c=(s+1)/2*this.pinSize;return this.g.append("path").attr("d",d3.svg.symbol().type("circle")).style("fill","none").style("stroke-width",.5).style("stroke","gray"),this.country.cohorts.forEach(function(s){t=ias.util.getNetworkColor(s.getNetwork()),c-=i.pinSize,e=0,a=i.pinScale(s.size/1e3);var l=new g2g.Pin(i.g,c,e,"",t,"white",i.pinSize,"pin cohort "+s.cssIdClass,a).on("mouseover",function(){n(i,s)}).on("mouseout",function(){r(i,s)}).on("click",function(){o(i,s)}).draw();l.id(i.country.id+"-"+s.code),i.cohortPins.push(l)}),this},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.legend=function(t){function e(){r(),l.append("rect").attr("class","legend").attr("x",150).attr("y",25).attr("width",20).attr("height",20).style("stroke","#000").style("stroke-width",".3px").style("fill",ias.config.map.background.naColor).attr("dx",-3).attr("dy",".35em"),l.append("text").attr("x",155).attr("y",22).attr("class","legend background").text("na"),l.append("text").attr("x",8).attr("y",22).attr("class","legend background").text("<"),l.append("text").attr("x",10).attr("y",0).attr("id","backgroundInfoTitle").attr("class","title legend").text(ias.config.legend.hivPrevalenceRate),l.append("text").attr("x",20).attr("y",65).attr("class","title legend").style("font-style","italic").text("Source: AIDSinfo")}function n(){var t,e,n=ias.config.map.cohort.pinScale,r=n.length,o="";n.forEach(function(n,a){o+=0===a?"< "+n:a===r?"> "+n:t+" - "+n,u.append("text").attr("y",15+10*a).attr("x",40).attr("class","legend").text(o),t=n,o="",e=d3.svg.arc().innerRadius(0).outerRadius(4).startAngle(0).endAngle(.125*2*Math.PI*(a+1)),u.append("path").attr("d",e).attr("transform","translate(30,"+(12+10*a)+")").style("fill","steelblue").style("stroke","steelblue").style("stroke-width",0),u.append("circle").attr("cx",30).attr("cy",12+10*a).attr("r",4).style("fill","none").style("stroke","steelblue").style("stroke-width",.5)}),l.append("text").attr("x",200).attr("y",0).attr("class","title legend").text("Cohort Size (K)"),new g2g.Pin(u,10,55,"","gray","white",15,"",.25).draw()}function r(){var t=ias.filter.getBackgroundInfoOption(),e=ias.config.map.background[t],n=l.selectAll("rect.legend.bckg").data(e.bands),r=l.selectAll("text.legend.bckg").data(e.bands);n.enter().append("rect").attr("class","legend bckg").attr("y",25).attr("x",function(t,e){return 22*e+15}).attr("width",20).attr("height",20).style("fill",function(t,n){return e.colors[n]}).style("opacity",ias.config.map.background.opacity).style("stroke","#000").style("stroke-width",".3px"),r.enter().append("text").attr("x",function(t,e){return 22*e+25}).attr("y",22).style("text-anchor","middle").attr("class","legend bckg").text(function(t){return t}),n.attr("x",function(t,e){return 22*e+15}).style("fill",function(t,n){return e.colors[n]}),r.attr("x",function(t,e){return 22*e+25}).text(function(t){return t}),n.exit().remove(),r.exit().remove()}function o(){e(),n()}function a(){}function i(){var t=ias.filter.getBackgroundInfoOption();l.select("#backgroundInfoTitle").text(ias.config.legend[t]),r()}var s=10,c=20,l=t.append("g").attr("id","blegend").attr("transform","translate("+s+","+c+")"),u=t.append("g").attr("id","clegend").attr("transform","translate("+(s+210)+","+c+")");return ias.filter.addListener(ias.filter.BACKGROUND_INFO,i),{draw:o,update:a,filterUpdate:i}},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.map=function(t){function e(t,e){var n="translate("+e.join(",")+")",r="scale("+t+")";f.attr("transform",n+r),f.selectAll("path").attr("d",ias.graph.path.projection(ias.graph.projection)),y.forEach(function(n){n.zoomAndPan(t,e)})}function n(t){var e;d3.event.stopPropagation(),t&&(e=ias.graph.path.centroid(t),r(t))}function r(t){var e=ias.util.getCountryId(t),n=ias.model.allcountriesById[e];m.select(n)}function o(){m.reset()}function a(){t.append("path").datum(d3.geo.graticule()).attr("class","graticule").attr("d",ias.graph.path),t.on("mousedown",i).on("mouseup",s).on("click",o),f.selectAll("path").data(ias.model.worldJson.features).enter().append("path").attr("class","country").attr("d",ias.graph.path).attr("pointer-events","fill").style("fill",function(t){return ias.util.getCountryColorByFeature(t)}).attr("id",function(t){return ias.util.getCountryId(t)}).style("opacity",ias.config.map.background.opacity).on("click",n),f.select("#ATA").remove(),ias.model.countriesWithCohorts.forEach(function(t){var e=new ias.graph.CountryPin(g,t).draw();y.push(e)})}function i(){t.style("cursor","move")}function s(){t.style("cursor","pointer")}function c(){}function l(t){return t===ias.filter.BACKGROUND_INFO?(ias.util.initBackgroundColors(),f.selectAll("path").style("fill",function(t){return ias.util.getCountryColorByFeature(t)}),void 0):(y.forEach(function(t){t.filter()}),void 0)}function u(){function t(t){return t&&"Cohort"===t.constructor.name?(n(t),r(null),void 0):t&&"Country"===t.constructor.name?(n(null),r(t),void 0):void 0}function e(){n(null),r(null)}function n(t){if(a!==t)if(a&&g.selectAll("circle.cohort."+a.cssIdClass).classed("selected",!1),a=t){var e=ias.util.getCohortHtml(a);ias.graph.tooltip.cohort.html(e),ias.graph.createSubjectsGraph(a.getSubjects()),ias.graph.tooltip.cohort.show(),g.selectAll("circle.cohort."+a.cssIdClass).classed("selected",!0)}else ias.graph.tooltip.cohort.hide()}function r(t){if(o!==t)if(o&&d3.select("#"+o.id).style("stroke","#000").style("stroke-width","0.1px"),o=t){ias.graph.tooltip.country.html(ias.util.getCountryHtml(o)).show();try{d3.select("#"+o.id).style("stroke","darkred").style("stroke-width","0.5px")}catch(e){}}else ias.graph.tooltip.country.hide()}var o,a;return{select:t,reset:e}}var p=-60,d=120,h=t.append("g").attr("id","mapcontainer").attr("transform","translate("+p+","+d+")"),f=h.append("g").attr("id","map").attr("class","map"),g=h.append("g").attr("id","pins_country").attr("class","pin country"),y=[],m=u();return ias.filter.addListener([ias.filter.NETWORKS,ias.filter.YEAR,ias.filter.ENROLLMENT_STATUS,ias.filter.BACKGROUND_INFO],l),ias.graph.zoom.register(t,e,[p,d]),{draw:a,update:c,filterUpdate:l,select:m.select}},t}(ias.graph||{}),ias.graph=function(t){"use strict";var e={male:"./images/male_adult.png",female:"./images/female_adult.png"};return t.createSubjectsGraph=function(t){function n(t,e){var n=e.subgroups.keys();return t.append("g").attr("transform","translate(10, 10)").selectAll("text").data(n).enter().append("svg:text").attr("class","label subjects").attr("dy",".35em").attr("x",10).attr("text-anchor","start").attr("y",function(t,e){return 1*e+"em"}).text(function(t){return t}).style("stroke",function(t){return a(t)}),12*n.length}function r(t,n,r,o){var i=50,s=70,c=2.4*s*r+s+30+o,l=30+s;n.subjects.map(function(t){return t.name});var u=t.append("svg:g").attr("transform","translate("+l+","+c+")"),p=d3.svg.arc().outerRadius(i-10).innerRadius(i-40),d=d3.svg.arc().outerRadius(i+10).innerRadius(i-38),h=d3.svg.arc().outerRadius(i+4).innerRadius(i+2),f=d3.svg.arc().outerRadius(i+22).innerRadius(i+20),g=d3.layout.pie().sort(null).value(function(t){return t.total}),y=u.selectAll("g.arc").data(g(n.subjects)).enter().append("g").attr("class","arc");u.append("text").attr("class","title subjects").attr("transform","translate(0,"+(-s-10)+")").attr("text-anchor","middle").text(n.group+": "+n.total),y.append("path").attr("d",p).attr("class","subjects").style("fill",function(t){return a(t.data.name)}),y.append("path").attr("d",f).attr("class","label subjects").attr("id",function(t,e){return"c"+e});var m=y.append("g").selectAll("path").data(function(t){var e=d3.layout.pie().sort(null).value(function(t){return t.total}).startAngle(t.startAngle).endAngle(t.endAngle),n=a(t.data.name);return e([{name:"male",total:t.data.male,color:n},{name:"female",total:t.data.female,color:n}])}).enter().append("g");m.append("path").attr("class",function(t){return t.data.name+" subjects"}).attr("d",d).style("stroke",function(t){return t.data.color}),m.append("svg:image").attr("xlink:href",function(t){return e[t.data.name]}).attr("x",function(t){return h.centroid(t)[0]-7}).attr("y",function(t){return h.centroid(t)[1]-20}).attr("width",14).attr("height",30).style("opacity",.8),m.append("svg:text").attr("class","label subjects").attr("dy",".35em").attr("text-anchor",function(t){return(t.startAngle+t.endAngle)/2>Math.PI?"end":"start"}).attr("x",function(t){return f.centroid(t)[0]}).attr("y",function(t){return f.centroid(t)[1]}).text(function(t){return t.data.total}).style("stroke",function(t){return t.data.color})}var o=d3.select("#tooltipsvg").append("svg").attr("width",200).attr("height",t?200*Object.keys(t).length:100),a=d3.scale.category10();if(t){var i=0,s=n(o,t);for(var c in t.data)t.data.hasOwnProperty(c)&&(r(o,t.data[c],i,s),i+=1)}else o.append("g").append("text").attr("x",0).attr("y",10).attr("class","tooltip").text("No subject details.")},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.title=function(t){function e(){a.append("text").attr("x",0).attr("y",0).attr("class","graphtitle").text(ias.config.title)}function n(){}var r=10,o=30,a=t.append("g").style("pointer-events","none").attr("transform","translate("+r+","+o+")");return{draw:e,update:n}},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.tooltip=function(t,e,n,r){var o={},a=d3.select("body").append("div").attr("class","tooltip "+(r||"")).attr("id",t).style("left",e[0]+"px").style("top",e[1]+"px").style("opacity",0).html(n);return o.show=function(){return a.transition().duration(100).style("opacity",1),o},o.hide=function(){return a.transition().duration(200).style("opacity",0),o},o.html=function(t){return a.html(t),o},o.style=function(t,e){return a.style(t,e),o},o.move=function(t){return a.style("left",t[0]+"px").style("top",t[1]+"px"),o},o},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.zoom=function(t){function e(t,e,n,r){u.append("image").attr("xlink:href","images/"+t+".png").attr("width",20).attr("height",20).attr("x",e).attr("y",n).attr("id",t).style("cursor","pointer").style("opacity",function(){return r?r:.2}).style("pointer-events",function(){return r?"all":"none"}).on("click",function(){s[t]()})}function n(){e("zoomin",50,20,1),e("zoomout",25,20),e("moveup",-20,10),e("movedown",-20,30),e("moveleft",-35,20),e("moveright",-5,20),u.append("text").attr("x",80).attr("y",32).attr("id","zoomFactor").text("scale:1")}function r(){}function o(t,e,n){s=i(t,e,n)}function a(t){u.selectAll("#moveup, #movedown, #moveright, #moveleft, #zoomout").style("opacity",1===t?"0.2":"1").style("pointer-events",1===t?"none":"all"),u.select("#zoomin").style("opacity",6>t?"1":"0.2").style("pointer-events",6>t?"all":"none"),u.select("#zoomFactor").text("scale:"+t.toFixed(1))}function i(t,e,n){function r(){var t=u,r=1;2>=t?u=1:4>=t?(u=2,r=2):6>=t&&(u=4,r=2),f.scale(u),1===u?(p[0]=0,p[1]=0):(p[0]+=r*(d/2-n[0]),p[1]+=r*(h/2-n[1])),f.translate(p),e(u,p),a(u)}function o(){var t=u,r=1;2>t?u=2:4>t?(u=4,r=2):6>t&&(u=6,r=2),f.scale(u),p[0]-=r*(d/2-n[0]),p[1]-=r*(h/2-n[1]),f.translate(p),e(u,p),a(u)}function i(){p[1]-=10,f.translate(p),e(u,p)}function s(){p[1]+=10,f.translate(p),e(u,p)}function c(){p[0]+=10,f.translate(p),e(u,p)}function l(){p[0]-=10,f.translate(p),e(u,p)}var u=1,p=[0,0],d=ias.config.map.width,h=ias.config.map.height,f=(ias.graph.projection([0,0]),d3.behavior.zoom().scaleExtent([1,6]).on("zoom",function(){u=d3.event.scale,p=d3.event.translate,e(u,p),a(u)}));return t.call(f),{zoomin:o,zoomout:r,moveleft:l,moveright:c,moveup:i,movedown:s}}var s,c=50,l=0,u=t.append("g").attr("id","buttons").style("pointer-events","none").attr("transform","translate("+c+","+l+")");return{draw:n,update:r,register:o}},t}(ias.graph||{}),ias.launchApp();