/*! ias 2013-03-28 */
var g2g_info={version:"v0.1"},g2g=function(t){"use strict";return t.GraphComponent=function(t,e,o,r,n){this.x=e,this.y=o,this.color=r,this.parent=t,this.g=t.append("g").attr("transform","translate("+e+","+o+")"),n&&this.g.attr("class",n)},t.GraphComponent.prototype.getXY=function(){return{x:this.x,y:this.y}},t.GraphComponent.prototype.setVisible=function(t){return this.g.style("display",t?"inline":"none"),this},t.GraphComponent.prototype.getNode=function(){return this.g},t.GraphComponent.prototype.draw=function(){return this},t.GraphComponent.prototype.select=function(){return this},t.GraphComponent.prototype.moveOnTop=function(){return this.parent.appendChild(this),this},t.Link=function(e,o,r,n){t.GraphComponent.call(this,e,0,0,r,n),this.elements=[],this.closed=!1;var a=d3.svg.area().x(function(t){return t.x}).y(function(t){return t.y}).interpolate(o),i=[];this.path=function(){return a(i)},this.addElement=function(t){var e=t.getXY();return this.elements.push(t),i.push(e),i.sort(function(t,e){return t.y-e.y}),this},this.close=function(){return this.closed?void 0:(i.push(this.elements[0].getXY()),this.closed=!0,this)}},t.Link.prototype=Object.create(t.GraphComponent.prototype),t.Link.prototype.select=function(t){return this.setVisible(t),this.elements.forEach(function(e){e.select(t)}),this},t.Link.prototype.draw=function(){return this.g.append("path").attr("d",this.path()).style("stroke",this.color),this},t.Options=function(t){if(this.listeners={},t){var e;for(e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}},t.Options.prototype.addListener=function(t,e){var o=Array.isArray(t)?t:[t],r=this;o.forEach(function(t){r.listeners.hasOwnProperty(t)===!1&&(r.listeners[t]=[]),e&&"function"==typeof e&&r.listeners[t].push(e)})},t.Options.prototype.getValue=function(t){return this.hasOwnProperty(t)?this[t]:void 0},t.Options.prototype.change=function(t,e){var o,r,n,a,i=t;if(t.indexOf(".")>0?(o=t.split("."),i=o[0],r=this[i][o[1]]):r=this[i],this.hasOwnProperty(i)&&r!==e&&(o?this[i][o[1]]=e:this[i]=e,this.listeners.hasOwnProperty(i)))for(a=this.listeners[i],n=0;a.length>n;n+=1)a[n].call(this,i)},t}(g2g_info),ias_info={mode:"offline",modules:[],config:{}},ias=function(t){"use strict";function e(e,o,r,n,a,i,s){var c;if(e)throw c="Error while loading data: "+e.message,t.showError(c),c;try{t.modules.forEach(function(t){t.init({world:o,centroids:r,networks:n,cohorts:a,hivrates:i,arvrates:s})}),t.modules.forEach(function(t){t.hasOwnProperty("run")&&t.run()}),t.showError()}catch(l){throw t.showError("Error while initializing IAS modules: "+l),l}}function o(e,o,r){var n;if(e)throw n="Error while loading data: "+e.message,t.showError(n),n;try{t.modules.forEach(function(t){t.update({networks:o,cohorts:r})}),t.showError()}catch(a){throw t.showError("Error while updating IAS modules: "+a),a}}return t.log=function(){console&&console.log&&console.log.apply(console,arguments)},t.showError=function(){d3.select("#error").text(arguments?arguments[0]:"")},t.launchApp=function(){return d3.json("./ias-config.json",function(e,o){if(e)throw"Error while loading configuration file: "+e.message;t.config=o;var r=window.top.location.search.replace("?","").split("=");t.mode=2===r.length&&"mode"===r[0]?r[1].replace("/",""):"offline",d3.select("#mode").text(t.mode+" mode"),t.loadData(t.mode)}),t},t.loadData=function(o){return queue().defer(d3.json,t.config.data.mapGeoJson).defer(d3.json,t.config.data.mapCentroids).defer(d3.json,t.config.data[o+"Networks"]).defer(d3.json,t.config.data[o+"Cohorts"]).defer(d3.csv,t.config.data.hivPrevalenceRate).defer(d3.csv,t.config.data.arvCoverageRate).await(e),t},t.reloadData=function(e){return queue().defer(d3.json,t.config.data[e+"Networks"]).defer(d3.json,t.config.data[e+"Cohorts"]).await(o),t},t}(ias_info);ias.util=function(){"use strict";var t,e={},o=d3.scale.linear(),r={},n={};return e.getNetworkColor=function(t){return r.hasOwnProperty(t)?r[t]:(ias.log("network color for"+t+" not found"),"white")},e.getCountryColor=function(t){var o=ias.model.getCountryById(t),r=o[ias.filter.getBackgroundInfoOption()];return void 0!==r&&"na"!==r?e.getBackgroundColor(r):ias.config.map.background.naColor},e.getBackgroundColor=function(t){return o(t)},e.getSelectedDomainRates=function(){return n[ias.filter.getBackgroundInfoOption()]},e.getCountryColorByFeature=function(t){var o=ias.model.getCountry(t.properties.name),r=o[ias.filter.getBackgroundInfoOption()];return void 0!==r&&"na"!==r?e.getBackgroundColor(r):ias.config.map.background.naColor},e.getCountryId=function(t){var e=t.id;return"-99"===e?"9"+t.properties.name.substring(0,2):t.id},e.getCohortHtml=function(t){var e="<span class='tooltip title'>Cohort</span><h1 class='tooltip'>"+t.name+":</h1>";return e+="<b>Number of subjects:</b>&nbsp;"+t.size+"<br>",e+="<b>Network:&nbsp;</b>"+t.getNetwork()+"<br>",e+="<b>Status:</b>&nbsp;"+t.status+"<br>",e+="<b>Countries:</b>&nbsp;",e+=t.getCountries().map(function(t){return t.name}).join(", ")+"<br>",e+="<b>Objectives:&nbsp;</b>",e+="<span class='tooltip objectives'>"+t.objectives+"</span>",e+="<br><br><a class='tooltip' target='_blank' href='"+ias.config.map.cohort.fullProfile.replace("$code$",t.code)+"'>View Full Profile</a>"},e.getCountryHtml=function(t){var e="<span class='tooltip title'>Country   "+t.id+"</span><h1 class='tooltip'>"+t.name+"</h1><table>",o="white";return e+="<tr><td class='firstcol'>HIV Prevalence Rate</td><td class='secondcol'>",e+=(t.hivPrevalenceRate||"na")+" %</td></tr>",e+="<tr><td>ARV Coverage Rate</td><td class='secondcol'>",e+=(t.arvCoverageRate||"na")+" %</td></tr>",t.cohorts&&t.cohorts.length>0&&(e+="<tr><td colspane='2'><br><b>COHORTS:</b></td></tr>",t.cohorts.forEach(function(t){o=ias.util.getNetworkColor(t.networks[0]),e+="<tr><td class='firstcol'><span style='background:",e+=o+";'>&nbsp;&nbsp;&nbsp;</span>&nbsp;",e+=t.name+"</td><td class='secondcol'>",e+=t.size+"</td></tr>"}),e+="<tr><td class='firstcol' style='text-align:right;'><b>Total</b></td><td class='secondcol'><b>",e+=t.size+"</b></td></tr>"),e+="</table>"},e.init=function(o){var a,i;t=ias.config.network.colorSchemes,o.networks.children.forEach(function(e,o){a=d3.scale.ordinal().range(colorbrewer[t[o]][6]),e.children.forEach(function(t){r[t.code]=a(t.code)})}),i=o.hivrates.filter(function(t){return!isNaN(t.rate)}).map(function(t){return parseFloat(t.rate)}),n.hivPrevalenceRate=[d3.min(i),d3.max(i)],i=o.arvrates.filter(function(t){return!isNaN(t.rate)}).map(function(t){return parseFloat(t.rate)}),n.arvCoverageRate=[d3.min(i),d3.max(i)],e.initBackgroundColors()},e.initBackgroundColors=function(){o.domain(e.getSelectedDomainRates()),o.range([ias.config.map.background.startColor,ias.config.map.background.endColor])},e.update=function(){},ias.modules.push(e),e}(),ias.filter=function(){"use strict";function t(t,e){var o=d3.select("#"+t).selectAll("input").data(e).enter().append("div");o.append("input").attr("checked",!0).attr("type","checkbox").attr("id",function(e){return t+e}).attr("value",function(t){return t}).attr("selected","selected"),o.append("label").attr("for",function(e){return t+e}).attr("class",t).text(function(t){return t})}var e,o,r={},n={},a=[],i={};for(e=1980;2013>=e;e+=1)a.push(e);return r.BACKGROUND_INFO="backgroundInfo",r.YEAR="year",r.NETWORKS="networks",r.ENROLLMENT_STATUS="enrollmentStatus",r.AGE_GROUP="ageGroup",i[r.BACKGROUND_INFO]="hivPrevalenceRate",i[r.YEAR]="1980",i[r.NETWORKS]={},i[r.ENROLLMENT_STATUS]="All",i[r.AGE_GROUP]="All",o=new g2g.Options(i),r.getValue=function(t){return o.getValue(t)},r.getBackgroundInfoOption=function(){return r.getValue(r.BACKGROUND_INFO)},r.addListener=function(t,e){o.addListener(t,e)},d3.select("#backgroundInfo").on("change",function(){var t=this.options[this.selectedIndex].value;o.change(r.BACKGROUND_INFO,t)}),d3.select("#year").on("change",function(){var t=parseInt(this.options[this.selectedIndex].value,10);o.change(r.YEAR,t)}).selectAll("option").data(a).enter().append("option").attr("value",function(t){return t}).text(function(t){return t}),r.init=function(e){function a(t,e){var o=t.code;return"EuroCoord"===o||"IeDEA"===o||"Other"===o?"network":"network "+e}function i(t){return"EuroCoord"===t||"IeDEA"===t||"Other"===t?"rgb(255,255,255)":ias.util.getNetworkColor(t)}function s(t,e){var n=e.code;"EuroCoord"===n||"IeDEA"===n||"Other"===n?d3.selectAll("input.network."+n).each(function(e){d3.select(this).property("checked",t.checked),o.change(r.NETWORKS+"."+e.code,t.checked)}):o.change(r.NETWORKS+"."+n,t.checked)}function c(t){var e=t.replace(/^rgb?\(|\s+|\)$/g,"").split(","),o=.3*e[0]+.59*e[1]+.11*e[2];return o}var l,u;n=ias.config.filter,d3.select("#status").on("change",function(){var t=this.options[this.selectedIndex].value;o.change(r.ENROLLMENT_STATUS,t)}).selectAll("option").data(n.enrollmentStatus).enter().append("option").attr("value",function(t){return t}).text(function(t){return t}),t("ageGroup",n.ageGroup),t("subjectStatus",n.subjectStatus),e.networks.children.forEach(function(t){l=t.children,l.forEach(function(t){o.networks[t.code]=!0}),l.unshift({code:t.code,name:t.name}),u=d3.select("#"+t.code).selectAll("div").data(l).enter().append("div").attr("class",function(e){return t.code!==e.code?"subnetwork":"network"}),u.append("input").attr("checked",!0).attr("class",function(e){return a(e,t.code)}).attr("type","checkbox").attr("id",function(t){return"n"+t.code}).on("click",function(t){return s(this,t)}),u.append("label").attr("class",function(e){return t.code===e.code?"network title":"network"}).attr("for",function(t){return"n"+t.code}).style("background",function(t){return c(i(t.code)),i(t.code)}).style("color",function(t){var e=i(t.code),o=c(e);return 130>o?"lightgray":"#666"}).text(function(t){return t.name}),"Other"!==t&&u.append("br")})},r.update=function(){},ias.modules.push(r),r}(),ias.model=function(){"use strict";var t={worldJson:{},networks:{},allcountries:[],allcountriesByName:{},allcountriesById:{},countriesWithCohorts:[],cohorts:[]};return t.getCountry=function(e){var o=t.allcountriesByName[e];return o},t.getCountryById=function(e){var o=t.allcountriesById[e];return o},t.init=function(e){t.worldJson=e.world,t.networks=e.networks.children,t.worldJson.features.forEach(function(e){var o=new ias.model.Country(e);t.allcountries.push(o),t.allcountriesByName[o.name]=o,t.allcountriesById[o.id]=o}),e.hivrates.forEach(function(e){var o=t.allcountriesByName[e.country];void 0!==o?o.hivPrevalenceRate=parseFloat(e.rate):ias.log("HIV Rates: no country found for "+e.country)}),e.arvrates.forEach(function(e){var o=t.allcountriesByName[e.country],r=parseFloat(e.rate);void 0!==o?o.arvCoverageRate=isNaN(r)?"na":r:ias.log("ARV Rates: no country found for "+e.country)}),e.cohorts.forEach(function(e){var o=new ias.model.Cohort(e);t.cohorts.push(o)}),t.allcountries.forEach(function(e){e.numberOfCohorts()>0&&t.countriesWithCohorts.push(e)})},t.update=function(){},ias.modules.push(t),t}(),ias.model=function(t){"use strict";return t.Cohort=function(e){this.status=e.status,this.code=e.code,this.name=e.name,this.objectives=e.objectives,this.year=e.year,this.size=e.size,this.networks=e.networks,this.countryData={};var o=this;e.countries.forEach(function(r){var n=t.allcountriesById[r.trim()];n?(o.addCountryData(n.id,10,n),n.addCohort(o),n.addNetwork(e.networks[0])):ias.log("Cohort country not found for "+r)})},t.Cohort.prototype.getCountryData=function(t){return this.countryData[t]},t.Cohort.prototype.getCountries=function(){var t=[];for(var e in this.countryData)this.countryData.hasOwnProperty(e)&&t.push(this.countryData[e].country);return t},t.Cohort.prototype.getCountryIds=function(){return Object.keys(this.countryData)},t.Cohort.prototype.addCountryData=function(t,e,o){var r=Object.create(ias.model.CountryData);r.countryId=t,r.size=e,r.country=o,this.countryData[t]=r,this.numberOfCountries+=1},t.Cohort.prototype.getNetwork=function(){return this.networks[0]},t}(ias.model||{}),ias.model=function(t){"use strict";return t.Country=function(t){this.feature=t,this.networks={},this.cohorts=[],this.hivPrevalenceRate="na",this.arvCoverageRate="na",this.size=0,this.id=t.id,"-99"===this.id&&(this.id="9"+t.properties.name.substring(0,2)),this.name=this.feature.properties.name},t.Country.prototype.addNetwork=function(t){this.networks.hasOwnProperty(t)===!1&&(this.networks[t]=t)},t.Country.prototype.getNetworks=function(){return Object.keys(this.networks)},t.Country.prototype.numberOfCohorts=function(){return this.cohorts?this.cohorts.length:0},t.Country.prototype.addCohort=function(t){return this.cohorts.push(t),this.size+=t.size,this},t.Country.prototype.getCohortIds=function(){var t=[];return this.cohorts&&this.cohorts.length>0&&this.cohorts.forEach(function(e){t.push(e.code)}),t},t}(ias.model||{}),ias.model=function(t){"use strict";return t.CountryData={countryId:"",size:0,country:null},t}(ias.model||{}),ias.graph=function(){"use strict";var t={components:[],selectedCohort:void 0,tooltip:{country:{},cohort:{}}};return t.projection=d3.geo.miller().precision(.1).scale(153),t.path=d3.geo.path().projection(t.projection),t.init=function(e){var o,r,n,a,i={};o=d3.select("#map").append("svg").attr("class","map").attr("width",ias.config.map.width).attr("height",ias.config.map.height),r=d3.select("#legend").append("svg").attr("class","legend").attr("width",ias.config.legend.width).attr("height",ias.config.legend.height),n=d3.select("#title").append("svg").attr("class","title").attr("width",360).attr("height",50),a=d3.select("#zoom").append("svg").attr("class","zoom").attr("width",180).attr("height",60),t.zoom=ias.graph.zoom(a),t.components.push(t.zoom),t.map=ias.graph.map(o),t.components.push(t.map),t.legend=ias.graph.legend(r),t.components.push(t.legend),t.components.push(ias.graph.title(n)),e.centroids.forEach(function(t){i[t.id]=t.ll}),t.tooltip.country=ias.graph.tooltip("tooltipCountry",ias.config.map.tooltip.country,"","country"),t.tooltip.cohort=ias.graph.tooltip("tooltipCohort",ias.config.map.tooltip.cohort,"","cohort"),ias.model.countriesWithCohorts.forEach(function(e){var o=[],r=i[e.name];o=r===void 0?t.path.centroid(e.feature):t.projection(r),e.centroidx=o[0],e.centroidy=o[1]})},t.update=function(){},t.run=function(){t.components.forEach(function(t){t.draw()})},t.selectCohort=function(e){t.selectedCohort!==e&&(t.selectedCohort!==void 0&&t.map.deselect(t.selectedCohort),t.selectedCohort=e,e!==void 0&&t.map.select(t.selectedCohort))},ias.modules.push(t),t}(),ias.graph=function(t){"use strict";function e(t,e,o){var r=o?.15:.9,n=o?"black":"#333",a=o?"bold":"normal";t.parent.selectAll("circle.cohort:not(."+e.cssIdClass+")").style("opacity",r),t.parent.selectAll("g.country.pin:not(."+e.cssIdClass+")").style("opacity",r),t.parent.selectAll("circle.country.pin."+e.cssIdClass).style("stroke",n),t.parent.selectAll("text.country.pin."+e.cssIdClass).style("fill",n).style("font-weight",a),t.parent.selectAll("text.country.pin.subjects."+e.cssIdClass).style("display",o?"none":"inline")}function o(t,o){o.cohorts||(e(t,o,!0),ias.graph.selectedCohort&&ias.graph.tooltip.cohort.hide())}function r(t,o){o.cohorts||(e(t,o,!1),ias.graph.selectedCohort&&ias.graph.tooltip.cohort.show())}function n(t,e){d3.event.stopPropagation(),e.cohorts||ias.graph.selectCohort(e)}return t.CountryPin=function(t,e){this.country=e,this.maxRadius=20,this.minRadius=5,this.scale=d3.scale.sqrt().domain([0,3e5]).range([this.minRadius,this.maxRadius]),this.radius=this.scale(this.country.size),this.pack=d3.layout.pack().size([this.radius,this.radius]).value(function(t){return t.size}).children(function(t){return t.cohorts}),this.nodes=this.pack.nodes(this.country);var o="";this.country.cohorts.forEach(function(t){t.cssIdClass="c"+t.code,o+=" "+t.cssIdClass}),this.classes="pin country"+o,g2g.GraphComponent.call(this,t,this.country.centroidx-this.radius/2,this.country.centroidy-this.radius/2,ias.util.getCountryColor(this.country.id),this.classes)},t.CountryPin.prototype=Object.create(g2g.GraphComponent.prototype),t.CountryPin.prototype.filter=function(){var t=ias.filter.getValue(ias.filter.NETWORKS),e=ias.filter.getValue(ias.filter.ENROLLMENT_STATUS),o=this;return this.country.cohorts.forEach(function(r){var n=t[r.getNetwork()];n&="All"===e||r.status===e,o.g.select("#"+o.country.id+"-"+r.code).style("display",n?"inline":"none")}),this},t.CountryPin.prototype.draw=function(){var t=this.g.selectAll("circle").data(this.nodes).enter(),e=this;return t.append("svg:circle").attr("class",function(t){return t.cohorts?e.classes:"cohort "+t.getNetwork()+" "+t.cssIdClass}).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.r}).attr("id",function(t){return e.country.id+"-"+t.code}).style("fill",function(t){return t.cohorts?"gray":ias.util.getNetworkColor(t.getNetwork())}).on("mouseover",function(t){o(e,t)}).on("mouseout",function(t){r(e,t)}).on("click",function(t){n(e,t)}),this.g.append("svg:text").attr("x",this.country.x).attr("y",this.country.y-1*this.radius/2).attr("dy","-.3em").attr("text-anchor","middle").attr("class",this.classes).text(this.country.name),this},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.legend=function(t){function e(){var t=ias.util.getSelectedDomainRates();f.tickValues(t),u.selectAll("stop").data(d).enter().append("svg:stop").attr("offset",function(t){return t+"%"}).attr("stop-color",function(e){return t[0]>e||e>t[1]?"white":ias.util.getBackgroundColor(e)}).attr("stop-opacity",1),c.append("g").attr("class","x axis").attr("transform","translate(10, 25)").call(h),c.append("g").attr("class","x axis selected").attr("transform","translate(10, 45)").call(f),c.append("svg:rect").attr("class","legend").attr("y",25).attr("x",10).attr("width",120).attr("height",20).style("fill","url(#gradient)").style("stroke","#000").style("stroke-width",".3px"),c.append("rect").attr("class","legend").attr("x",145).attr("y",25).attr("width",20).attr("height",20).style("stroke","#000").style("stroke-width",".3px").style("fill",ias.config.map.background.naColor).attr("dx",-3).attr("dy",".35em"),c.append("text").attr("x",150).attr("y",15).attr("class","legend background").text("n/a"),c.append("text").attr("x",10).attr("y",0).attr("id","backgroundInfoTitle").attr("class","title legend").text(ias.config.legend.hivPrevalenceRate)}function o(){var t=ias.config.legend.cohorts,e=d3.scale.sqrt().domain([0,3e5]).range([2,15]);l.selectAll("circle").data(t).enter().append("circle").attr("cx",20).attr("cy",function(t){return 50-e(t)}).style("fill","none","opacity",1).style("stroke",ias.config.map.cohort.linkcolor).style("stroke-width","1px").attr("r",function(t){return e(t)}),l.selectAll("text").data(t).enter().append("text").attr("y",function(t){return 50-2*e(t)+4}).attr("x",40).attr("class","legend").text(function(t,e){return 4===e?">"+t:t}),c.append("text").attr("x",200).attr("y",0).attr("class","title legend").text("Cohort Size")}function r(){e(),o(),t.append("g").append("text").attr("x",ias.config.legend.width-3).attr("y",ias.config.legend.height-3).style("text-anchor","end").style("font-size","0.7em").style("fill","gray").text("version: "+ias.config.version+" - "+ias.config.timestamp+"  ("+ias.mode+")")}function n(){}function a(){var t=ias.filter.getBackgroundInfoOption();c.select("#backgroundInfoTitle").text(ias.config.legend[t]);var e=ias.util.getSelectedDomainRates();f.tickValues(e),c.select(".x.axis.selected").call(f),u.selectAll("stop").attr("offset",function(t){return t+"%"}).attr("stop-color",function(t){return e[0]>t||t>e[1]?"white":ias.util.getBackgroundColor(t)}).attr("stop-opacity",1)}for(var i=0,s=20,c=t.append("g").attr("id","blegend").attr("transform","translate("+i+","+s+")"),l=t.append("g").attr("id","clegend").attr("transform","translate("+(i+200)+","+s+")"),u=t.append("svg:defs").append("svg:linearGradient").attr("id","gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad"),d=[],p=d3.scale.linear().domain([0,100]).range([0,120]),h=d3.svg.axis().scale(p).orient("top").ticks(5),f=d3.svg.axis().scale(p).orient("bottom"),g=0;100>g;g++)d[g]=g;return ias.filter.addListener(ias.filter.BACKGROUND_INFO,a),{draw:r,update:n,filterUpdate:a}},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.map=function(t){function e(){var t="translate("+z.join(",")+")";t+="scale("+N+")",x.attr("transform",t),x.selectAll("path").attr("d",ias.graph.path.projection(ias.graph.projection)),E.attr("transform",t),ias.graph.zoom.zoomed(N)}function o(t){var o;d3.event.stopPropagation(),t&&(o=ias.graph.path.centroid(t),z[0]=-o[0]+R[0],z[1]=-o[1]+R[1],e(),r(t))}function r(t){var e=ias.util.getCountryId(t),o=ias.model.allcountriesById[e];C&&a(!1),C=o,ias.graph.tooltip.country.html(ias.util.getCountryHtml(o)).show(),a(!0)}function n(){a(!1),ias.graph.tooltip.country.hide(),C=null,ias.graph.selectCohort()}function a(t){var e=t?"darkred":"#000",o=t?.5:.1;try{d3.select("#"+C.id).style("stroke",e).style("stroke-width",o+"px")}catch(r){}}function i(){var t=N,o=1;2>=t?N=1:4>=t?(N=2,o=2):6>=t&&(N=4,o=2),B.scale(N),1===N?(z[0]=0,z[1]=0):(z[0]+=o*(A/2-w),z[1]+=o*(I/2-k)),B.translate(z),e()}function s(){var t=N,o=1;2>t?N=2:4>t?(N=4,o=2):6>t&&(N=6,o=2),B.scale(N),z[0]-=o*(A/2-w),z[1]-=o*(I/2-k),B.translate(z),e()}function c(){z[1]-=10,B.translate(z),e()}function l(){z[1]+=10,B.translate(z),e()}function u(){z[0]+=10,B.translate(z),e()}function d(){z[0]-=10,B.translate(z),e()}function p(){t.append("path").datum(d3.geo.graticule()).attr("class","graticule").attr("d",ias.graph.path),t.on("mousedown",h).on("mouseup",f).on("click",n),x.selectAll("path").data(ias.model.worldJson.features).enter().append("path").attr("class","country").attr("d",ias.graph.path).attr("pointer-events","fill").style("fill",function(t){return ias.util.getCountryColorByFeature(t)}).attr("id",function(t){return ias.util.getCountryId(t)}).style("opacity",ias.config.map.background.opacity).on("click",o),x.append("circle").attr("cx",R[0]-w/2).attr("cy",R[1]-k/2).attr("r",5).style("fill","black"),x.select("#ATA").remove(),ias.model.countriesWithCohorts.forEach(function(t){var e=new ias.graph.CountryPin(E,t).draw();O.push(e)})}function h(){t.style("cursor","move")}function f(){t.style("cursor","pointer")}function g(){}function y(t){return t===ias.filter.BACKGROUND_INFO?(ias.util.initBackgroundColors(),x.selectAll("path").style("fill",function(t){return ias.util.getCountryColorByFeature(t)}),void 0):(O.forEach(function(t){t.filter()}),void 0)}function m(t){"Cohort"===t.constructor.name&&(ias.graph.tooltip.cohort.html(ias.util.getCohortHtml(t)).show(),E.selectAll("circle.cohort."+t.cssIdClass).classed("selected",!0))}function v(t){"Cohort"===t.constructor.name&&(ias.graph.tooltip.cohort.hide(),E.selectAll("circle.cohort."+t.cssIdClass).classed("selected",!1))}var C,w=-60,k=120,b=t.append("g").attr("id","mapcontainer").attr("transform","translate("+w+","+k+")"),x=b.append("g").attr("id","map").attr("class","map"),E=b.append("g").attr("id","pins_country").attr("class","pin country"),O=[],N=1,A=ias.config.map.width,I=ias.config.map.height,R=ias.graph.projection([0,0]),z=[0,0],B=d3.behavior.zoom().scaleExtent([1,6]).on("zoom",function(){ias.log(N+":"+d3.event.scale),ias.log(z+":"+d3.event.translate),z=d3.event.translate,N=d3.event.scale,e()});return t.call(B),ias.filter.addListener([ias.filter.NETWORKS,ias.filter.YEAR,ias.filter.ENROLLMENT_STATUS,ias.filter.BACKGROUND_INFO],y),{draw:p,update:g,filterUpdate:y,zoomout:i,zoomin:s,moveup:c,movedown:l,moveright:u,moveleft:d,select:m,deselect:v}},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.title=function(t){function e(){a.append("text").attr("x",0).attr("y",0).attr("class","graphtitle").text(ias.config.title)}function o(){}var r=10,n=30,a=t.append("g").style("pointer-events","none").attr("transform","translate("+r+","+n+")");return{draw:e,update:o}},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.tooltip=function(t,e,o,r){var n={},a=d3.select("body").append("div").attr("class","tooltip "+(r||"")).attr("id",t).style("left",e[0]+"px").style("top",e[1]+"px").style("opacity",0).html(o);return n.show=function(){return a.transition().duration(100).style("opacity",1),n},n.hide=function(){return a.transition().duration(200).style("opacity",0),n},n.html=function(t){return a.html(t),n},n.style=function(t,e){return a.style(t,e),n},n.move=function(t){return a.style("left",t[0]+"px").style("top",t[1]+"px"),n},n},t}(ias.graph||{}),ias.graph=function(t){"use strict";return t.zoom=function(t){function e(t,e,o,r){s.append("image").attr("xlink:href","images/"+t+".png").attr("width",20).attr("height",20).attr("x",e).attr("y",o).attr("id",t).style("cursor","pointer").style("opacity",function(){return r?r:.2}).style("pointer-events",function(){return r?"all":"none"}).on("click",ias.graph.map[t])}function o(){e("zoomin",50,20,1),e("zoomout",25,20),e("moveup",-20,10),e("movedown",-20,30),e("moveleft",-35,20),e("moveright",-5,20),s.append("text").attr("x",80).attr("y",32).attr("id","zoomFactor").text("scale:1")}function r(){}function n(t){s.selectAll("#moveup, #movedown, #moveright, #moveleft, #zoomout").style("opacity",1===t?"0.2":"1").style("pointer-events",1===t?"none":"all"),s.select("#zoomin").style("opacity",6>t?"1":"0.2").style("pointer-events",6>t?"all":"none"),s.select("#zoomFactor").text("scale:"+t.toFixed(1))}var a=50,i=0,s=t.append("g").attr("id","buttons").style("pointer-events","none").attr("transform","translate("+a+","+i+")");return{draw:o,update:r,zoomed:n}},t}(ias.graph||{}),ias.launchApp();